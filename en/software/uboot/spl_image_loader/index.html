
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="offical site of NINJAR-lite">
      
      
        <meta name="author" content="embeddedboys">
      
      
        <link rel="canonical" href="https://embeddedboys.github.io/NINJAR-lite/en/software/uboot/spl_image_loader/">
      
      
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.10">
    
    
      
        <title>Spl image loader - NINJAR-lite</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.fad675c6.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="green">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../" title="NINJAR-lite" class="md-header__button md-logo" aria-label="NINJAR-lite" data-md-component="logo">
      
  <img src="../../../../assets/048-boy-next.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            NINJAR-lite
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Spl image loader
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="green"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../../../software/uboot/spl_image_loader/" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/embeddedboys/NINJAR-lite" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../" title="NINJAR-lite" class="md-nav__button md-logo" aria-label="NINJAR-lite" data-md-component="logo">
      
  <img src="../../../../assets/048-boy-next.png" alt="logo">

    </a>
    NINJAR-lite
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/embeddedboys/NINJAR-lite" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/check/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    检查
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/parts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    组装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    测试
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Wiki
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wiki
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Software
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../dev/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development record
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    About
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            About
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../credits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Credits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../license/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../releasenote/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Release Note
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../FAQs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FAQs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../thanks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Thank
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      目录
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      名词解释
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      写在前面
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      启动流程
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      实现
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      优化思路
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      基准测试
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基准测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spi" class="md-nav__link">
    <span class="md-ellipsis">
      SPI速率
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      更多
    </span>
  </a>
  
    <nav class="md-nav" aria-label="更多">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#w25n01g" class="md-nav__link">
    <span class="md-ellipsis">
      W25N01G的读操作流程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#f1c100s-spi" class="md-nav__link">
    <span class="md-ellipsis">
      全志 F1C100s SPI裸机通信的
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      参考资料
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 align="center">让 F1C100s 从 SPI Nand 启动</h1>

<h2 id="_1">目录</h2>
<ul>
<li><a href="#名词解释">名词解释</a></li>
<li><a href="#写在前面">写在前面</a></li>
<li><a href="#启动流程">启动流程</a></li>
<li><a href="#实现">实现</a></li>
<li>[内核]</li>
<li>[文件系统]</li>
<li>[打包烧录]</li>
<li><a href="#优化思路">优化思路</a></li>
<li><a href="#基准测试">基准测试</a></li>
<li><a href="#更多">更多</a></li>
<li><a href="#参考资料">参考资料</a></li>
</ul>
<h2 id="_2">名词解释</h2>
<table>
<thead>
<tr>
<th>名词</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>SPL</td>
<td>第二阶段程序加载器</td>
</tr>
<tr>
<td>BootROM</td>
<td>固化在芯片内部的程序，用来识别并加载固件</td>
</tr>
</tbody>
</table>
<h2 id="_3">写在前面</h2>
<p>本次实验平台基于如下环境</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>SoC</td>
<td>Allwinner Suniv F1C100s</td>
</tr>
<tr>
<td>u-boot</td>
<td>v2023.07</td>
</tr>
<tr>
<td>linux</td>
<td>6.4.0-rc4</td>
</tr>
<tr>
<td>buildroot</td>
<td>v2023.02</td>
</tr>
<tr>
<td>spi nand</td>
<td>Winbond W25N01G</td>
</tr>
</tbody>
</table>
<p>其实就是当时我从主线上master直接搞过来的，基本就是现在最新状态</p>
<p>如何从零构建一个完整的可从spi-nand启动的镜像？</p>
<p>可以说这是一份教程，也可以说是一次记录</p>
<h2 id="_4">启动流程</h2>
<p>在正式开始之前，不妨先谈谈启动流程， 当然， 只是针对全志平台。</p>
<p>首先， 芯片内部的<strong>BootROM</strong>将<strong>spi-nand</strong>中的数据读取到SRAM中执行，但是为了兼容性（由于nand的page大小不同），<strong>BootROM只读取spi-nand中
每个page的前1024Bytes</strong>，这意味这你得对<code>U-Boot SPL</code>进行处理，将其分成按1K每Page的格式存放。</p>
<p>这得多亏了 <a href="https://github.com/bamkrs">bamkrs</a> 提供的脚本 <a href="https://github.com/bamkrs/openwrt/blob/dolphinpi-spinand/target/linux/sunxi/image/gen_sunxi_spinand_onlyboot_img.sh">gen_sunxi_spinand_onlyboot_img.sh</a>，你只需要输入page，erase block大小，就能让<code>u-boot-sunxi-with-spl.bin</code>中的<code>SPL</code>能够按<strong>BootROM</strong>需要的格式存放到flash中。好吧，有了这个东西，意味着从<strong>spi-nand</strong>启动变的可能。</p>
<p>我为了方便测试，所以通过<code>sunxi-fel</code>来烧录测试，
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>sudo<span class="w"> </span>sunxi-fel<span class="w"> </span>uboot<span class="w"> </span>u-boot-sunxi-with-spl.bin
</code></pre></div>
就这样， SPL运行了，接下来我们追究下 SPL 的执行流程，因为我们侧重点在启动部分，所以直接从日志切入</p>
<p>当你使用如上模式启动时，串口打印日志如下
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">U</span><span class="o">-</span><span class="n">Boot</span><span class="w"> </span><span class="n">SPL</span><span class="w"> </span><span class="mf">2023.07</span><span class="o">-</span><span class="n">rc4ninjar</span><span class="o">-</span><span class="n">lite</span><span class="o">-</span><span class="n">g1c30e10017</span><span class="o">-</span><span class="n">dirty</span><span class="w"> </span><span class="p">(</span><span class="n">Jun</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">2023</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">08</span><span class="o">:</span><span class="mi">33</span><span class="o">:</span><span class="mi">14</span><span class="w"> </span><span class="mo">-0400</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nl">DRAM</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">MiB</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">Unknown</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">BROM</span><span class="o">:</span><span class="w"> </span><span class="mh">0xe1a00000</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">Trying</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">boot</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">FEL</span>
</code></pre></div>
可以看到，关键点就在于最后一句，<code>Trying to boot from XXX</code>，定位到<a href="https://github.com/u-boot/u-boot/blob/ninjar-lite/common/spl/spl.c#L712">common/spl/spl.c + 712</a>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">boot_from_devices</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">spl_image_info</span><span class="w"> </span><span class="o">*</span><span class="n">spl_image</span><span class="p">,</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">                 </span><span class="n">u32</span><span class="w"> </span><span class="n">spl_boot_list</span><span class="p">[],</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="p">{</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="p">...</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CONFIG_IS_ENABLED</span><span class="p">(</span><span class="n">SILENT_CONSOLE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Trying to boot from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">                           </span><span class="n">spl_loader_name</span><span class="p">(</span><span class="n">loader</span><span class="p">));</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="p">...</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loader</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">                </span><span class="o">!</span><span class="n">spl_load_image</span><span class="p">(</span><span class="n">spl_image</span><span class="p">,</span><span class="w"> </span><span class="n">loader</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">                </span><span class="n">spl_image</span><span class="o">-&gt;</span><span class="n">boot_device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bootdev</span><span class="p">;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="p">...</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="p">}</span>
</code></pre></div>
查看 <code>boot_from_devices</code> 的调用者， 定位到<a href="https://github.com/u-boot/u-boot/blob/ninjar-lite/common/spl/spl.c#L831">common/spl/spl.c + 831</a>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">board_init_r</span><span class="p">(</span><span class="n">gd_t</span><span class="w"> </span><span class="o">*</span><span class="n">dummy1</span><span class="p">,</span><span class="w"> </span><span class="n">ulong</span><span class="w"> </span><span class="n">dummy2</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="p">...</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="n">spl_image</span><span class="p">.</span><span class="n">boot_device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOOT_DEVICE_NONE</span><span class="p">;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="n">board_boot_order</span><span class="p">(</span><span class="n">spl_boot_list</span><span class="p">);</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boot_from_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spl_image</span><span class="p">,</span><span class="w"> </span><span class="n">spl_boot_list</span><span class="p">,</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">                </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">spl_boot_list</span><span class="p">));</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="p">...</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="p">}</span>
</code></pre></div>
你可以看到，他通过调用<code>board_boot_order</code>获取到了一个boot list，这个函数的原型是
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">__weak</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">board_boot_order</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">spl_boot_list</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="n">spl_boot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spl_boot_device</span><span class="p">();</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="p">}</span>
</code></pre></div>
他又通过调用 <code>spl_boot_device</code> 来获取启动设备，将其放入list首位，也就是将要启动的设备。
我看过了，这个函数只是个声明，对于全志平台，是这么实现的，位于文件<code>arch/arm/mach-sunxi/board.c</code>中，
调用流程如下
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">spl_boot_device</span><span class="w"> </span><span class="o">-&gt;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="n">sunxi_get_boot_device</span><span class="w"> </span><span class="o">-&gt;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">        </span><span class="n">sunxi_get_boot_source</span><span class="w"> </span><span class="o">-&gt;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">            </span><span class="n">suniv_get_boot_source</span>
</code></pre></div></p>
<p>我把相关的函数都放到下面了，你可以花点时间整理下思路
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">u32</span><span class="w"> </span><span class="nf">spl_boot_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sunxi_get_boot_device</span><span class="p">();</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="p">}</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">sunxi_get_boot_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="p">{</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">boot_source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sunxi_get_boot_source</span><span class="p">();</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">boot_source</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNXI_INVALID_BOOT_SOURCE</span><span class="p">:</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BOOT_DEVICE_BOARD</span><span class="p">;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNXI_BOOTED_FROM_MMC0</span><span class="p">:</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNXI_BOOTED_FROM_MMC0_HIGH</span><span class="p">:</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BOOT_DEVICE_MMC1</span><span class="p">;</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNXI_BOOTED_FROM_NAND</span><span class="p">:</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BOOT_DEVICE_NAND</span><span class="p">;</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNXI_BOOTED_FROM_MMC2</span><span class="p">:</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNXI_BOOTED_FROM_MMC2_HIGH</span><span class="p">:</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BOOT_DEVICE_MMC2</span><span class="p">;</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNXI_BOOTED_FROM_SPI</span><span class="p">:</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BOOT_DEVICE_SPI</span><span class="p">;</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unknown boot source %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">boot_source</span><span class="p">);</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Never reached */</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="p">}</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">sunxi_get_boot_source</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="p">{</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">boot_file_head</span><span class="w"> </span><span class="o">*</span><span class="n">egon_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">SPL_ADDR</span><span class="p">;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">toc0_main_info</span><span class="w"> </span><span class="o">*</span><span class="n">toc0_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">SPL_ADDR</span><span class="p">;</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUNIV</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="w">        </span><span class="o">!</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SPL_BUILD</span><span class="p">))</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_BOOTED_FROM_MMC0</span><span class="p">;</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUNIV</span><span class="p">))</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">suniv_get_boot_source</span><span class="p">();</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sunxi_egon_valid</span><span class="p">(</span><span class="n">egon_head</span><span class="p">))</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">egon_head</span><span class="o">-&gt;</span><span class="n">boot_media</span><span class="p">);</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sunxi_toc0_valid</span><span class="p">(</span><span class="n">toc0_info</span><span class="p">))</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">toc0_info</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="w">    </span><span class="cm">/* Not a valid image, so we must have been booted via FEL. */</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_INVALID_BOOT_SOURCE</span><span class="p">;</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="p">}</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">suniv_get_boot_source</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a><span class="p">{</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="w">    </span><span class="cm">/* Get the last function call from BootROM&#39;s stack. */</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">brom_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">fel_stash</span><span class="p">.</span><span class="n">sp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a><span class="w">    </span><span class="cm">/* translate SUNIV BootROM stack to standard SUNXI boot sources */</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">brom_call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNIV_BOOTED_FROM_MMC0</span><span class="p">:</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_BOOTED_FROM_MMC0</span><span class="p">;</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNIV_BOOTED_FROM_SPI</span><span class="p">:</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_BOOTED_FROM_SPI</span><span class="p">;</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNIV_BOOTED_FROM_MMC1</span><span class="p">:</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_BOOTED_FROM_MMC2</span><span class="p">;</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="w">    </span><span class="cm">/* SPI NAND is not supported yet. */</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNIV_BOOTED_FROM_NAND</span><span class="p">:</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_INVALID_BOOT_SOURCE</span><span class="p">;</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="w">    </span><span class="cm">/* If we get here something went wrong try to boot from FEL.*/</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unknown boot source from BROM: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">brom_call</span><span class="p">);</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_INVALID_BOOT_SOURCE</span><span class="p">;</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="p">}</span>
</code></pre></div>
其实就是把全志的启动源，转换为u-boot定义的启动源，这么做的原因主要是u-boot通过一个宏<code>SPL_LOAD_IMAGE_METHOD</code>来添加一个<code>spl loader</code>，而前面的函数<code>boot_from_devices</code>里就会比对这个数值，选择相应的<code>spl loader</code>，这个宏的原型如下
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="cp">#define SPL_LOAD_IMAGE_METHOD(_name, _priority, _boot_device, _method) \</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="cp">    SPL_LOAD_IMAGE(_boot_device ## _priority ## _method) = { \</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="cp">        .name = _name, \</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="cp">        .boot_device = _boot_device, \</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="cp">        .load_image = _method, \</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="cp">    }</span>
</code></pre></div>
这个宏接收四个参数，返回一个结构体对象，该结构体如下
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">spl_image_loader</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="cp">#ifdef CONFIG_SPL_LIBCOMMON_SUPPORT</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="cp">#endif</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">boot_device</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="cm">     * load_image() - Load an SPL image</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="cm">     *</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="cm">     * @spl_image: place to put image information</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="cm">     * @bootdev: describes the boot device to load from</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="cm">     */</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">load_image</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">spl_image_info</span><span class="w"> </span><span class="o">*</span><span class="n">spl_image</span><span class="p">,</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">              </span><span class="k">struct</span><span class="w"> </span><span class="nc">spl_boot_device</span><span class="w"> </span><span class="o">*</span><span class="n">bootdev</span><span class="p">);</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="p">};</span>
</code></pre></div></p>
<p>我们先找一个现有的例子看看该结构体如下
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">spl_board_load_image</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">spl_image_info</span><span class="w"> </span><span class="o">*</span><span class="n">spl_image</span><span class="p">,</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">spl_boot_device</span><span class="w"> </span><span class="o">*</span><span class="n">bootdev</span><span class="p">)</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="p">{</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Returning to FEL sp=%x, lr=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fel_stash</span><span class="p">.</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">fel_stash</span><span class="p">.</span><span class="n">lr</span><span class="p">);</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="n">return_to_fel</span><span class="p">(</span><span class="n">fel_stash</span><span class="p">.</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">fel_stash</span><span class="p">.</span><span class="n">lr</span><span class="p">);</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="p">}</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="n">SPL_LOAD_IMAGE_METHOD</span><span class="p">(</span><span class="s">&quot;FEL&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">BOOT_DEVICE_BOARD</span><span class="p">,</span><span class="w"> </span><span class="n">spl_board_load_image</span><span class="p">);</span>
</code></pre></div></p>
<p>可以看到，1. 名字  2. 优先级 3.启动源 4. 启动函数，原来上面<code>spl_image_loader</code>结构体里<code>boot_device</code>成员里存放的就是这个宏传入的启动源。 我们可以试着写一个从<code>spi-nand</code>启动的宏了，但东西都还没有实现，当然了！
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">SPL_LOAD_IMAGE_METHOD</span><span class="p">(</span><span class="s">&quot;sunxi SPI-NAND&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">BOOT_DEVICE_NAND</span><span class="p">,</span><span class="w"> </span><span class="n">spl_spi_nand_load_image</span><span class="p">);</span>
</code></pre></div></p>
<p>看到这里我们大概了解了，怎么去实现一个自定义的<code>spl loader</code>了。本文章的<code>实现</code>章节会有相应细节，我们继续看往下流程。</p>
<p>所以我假设你已经实现了从<code>spi-nand</code>启动的loader，接着往下看。<code>boot_from_devices</code>调用完成以后，经过一堆东西，来到函数<code>board_init_r</code>最底下
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="p">...</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="n">spl_board_prepare_for_boot</span><span class="p">();</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="n">jump_to_image_no_args</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spl_image</span><span class="p">);</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="p">}</span>
</code></pre></div>
<code>spl_board_prepare_for_boot</code>是一个声明，可以让你实现跳转u-boot前所做的最后工作。
<code>jump_to_image_no_args</code> 就是跳转到u-boot入口的函数了，实现如下
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">__weak</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__noreturn</span><span class="w"> </span><span class="n">jump_to_image_no_args</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">spl_image_info</span><span class="w"> </span><span class="o">*</span><span class="n">spl_image</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__noreturn</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">image_entry_noargs_t</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">image_entry_noargs_t</span><span class="w"> </span><span class="n">image_entry</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">        </span><span class="p">(</span><span class="n">image_entry_noargs_t</span><span class="p">)</span><span class="n">spl_image</span><span class="o">-&gt;</span><span class="n">entry_point</span><span class="p">;</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;image entry point: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">spl_image</span><span class="o">-&gt;</span><span class="n">entry_point</span><span class="p">);</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="n">image_entry</span><span class="p">();</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="p">}</span>
</code></pre></div>
可以看到，定义了一个void *函数指针，指向了从<code>spl_image</code>中解析出的<code>entry_point</code>，通过直接调用这个指针，就跳转到了u-boot中，这个<code>entry_point</code>是通过解析u-boot头部得到的，这个头部结构体是<code>legacy_img_hdr</code>，定义如下
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="cp">#define IH_NMLEN        32  </span><span class="cm">/* Image Name Length        */</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">legacy_img_hdr</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">    </span><span class="n">ih_magic</span><span class="p">;</span><span class="w">   </span><span class="cm">/* Image Header Magic Number    */</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">    </span><span class="n">ih_hcrc</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Image Header CRC Checksum    */</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">    </span><span class="n">ih_time</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Image Creation Timestamp */</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">    </span><span class="n">ih_size</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Image Data Size      */</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">    </span><span class="n">ih_load</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Data  Load  Address      */</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">    </span><span class="n">ih_ep</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Entry Point Address      */</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">    </span><span class="n">ih_dcrc</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Image Data CRC Checksum  */</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w">     </span><span class="n">ih_os</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Operating System     */</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w">     </span><span class="n">ih_arch</span><span class="p">;</span><span class="w">    </span><span class="cm">/* CPU architecture     */</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w">     </span><span class="n">ih_type</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Image Type           */</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w">     </span><span class="n">ih_comp</span><span class="p">;</span><span class="w">    </span><span class="cm">/* Compression Type     */</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w">     </span><span class="n">ih_name</span><span class="p">[</span><span class="n">IH_NMLEN</span><span class="p">];</span><span class="w">  </span><span class="cm">/* Image Name       */</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="p">};</span>
</code></pre></div>
我们通过<code>hexdump</code>工具查看<code>u-boot.img</code>头部，得到如下信息
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="mo">00000000</span><span class="w">  </span><span class="mi">27</span><span class="w"> </span><span class="mo">05</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="mi">56</span><span class="w"> </span><span class="mi">9</span><span class="n">b</span><span class="w"> </span><span class="n">b7</span><span class="w"> </span><span class="mi">3</span><span class="n">b</span><span class="w"> </span><span class="n">c2</span><span class="w">  </span><span class="mi">64</span><span class="w"> </span><span class="mi">9</span><span class="n">e</span><span class="w"> </span><span class="mi">77</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">06</span><span class="w"> </span><span class="mo">06</span><span class="w"> </span><span class="n">c0</span><span class="w">  </span><span class="o">|</span><span class="err">&#39;</span><span class="p">..</span><span class="n">V</span><span class="p">..;.</span><span class="n">d</span><span class="p">.</span><span class="n">w</span><span class="p">.....</span><span class="o">|</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="mo">00000010</span><span class="w">  </span><span class="mi">81</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w">  </span><span class="n">b6</span><span class="w"> </span><span class="mi">2</span><span class="n">e</span><span class="w"> </span><span class="mi">5</span><span class="n">e</span><span class="w"> </span><span class="mi">67</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mo">02</span><span class="w"> </span><span class="mo">05</span><span class="w"> </span><span class="mo">00</span><span class="w">  </span><span class="o">|</span><span class="p">.</span><span class="n">p</span><span class="p">...</span><span class="n">p</span><span class="p">....</span><span class="o">^</span><span class="n">g</span><span class="p">....</span><span class="o">|</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="mo">00000020</span><span class="w">  </span><span class="mi">55</span><span class="w"> </span><span class="mi">2</span><span class="n">d</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="mf">6f</span><span class="w"> </span><span class="mf">6f</span><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">32</span><span class="w">  </span><span class="mi">30</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="mi">2</span><span class="n">e</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">37</span><span class="w"> </span><span class="mi">2</span><span class="n">d</span><span class="w"> </span><span class="mi">72</span><span class="w">  </span><span class="o">|</span><span class="n">U</span><span class="o">-</span><span class="n">Boot</span><span class="w"> </span><span class="mf">2023.07</span><span class="o">-</span><span class="n">r</span><span class="o">|</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="mo">00000030</span><span class="w">  </span><span class="mi">63</span><span class="w"> </span><span class="mi">34</span><span class="w"> </span><span class="mi">6</span><span class="n">e</span><span class="w"> </span><span class="mi">69</span><span class="w"> </span><span class="mi">6</span><span class="n">e</span><span class="w"> </span><span class="mi">6</span><span class="n">a</span><span class="w"> </span><span class="mi">61</span><span class="w"> </span><span class="mi">72</span><span class="w">  </span><span class="mi">2</span><span class="n">d</span><span class="w"> </span><span class="mi">6</span><span class="n">c</span><span class="w"> </span><span class="mi">69</span><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="mi">65</span><span class="w"> </span><span class="mi">2</span><span class="n">d</span><span class="w"> </span><span class="mi">67</span><span class="w"> </span><span class="mi">61</span><span class="w">  </span><span class="o">|</span><span class="n">c4ninjar</span><span class="o">-</span><span class="n">lite</span><span class="o">-</span><span class="n">ga</span><span class="o">|</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="mo">00000040</span><span class="w">  </span><span class="n">b8</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="n">ea</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">f0</span><span class="w"> </span><span class="mf">9f</span><span class="w"> </span><span class="n">e5</span><span class="w">  </span><span class="mi">14</span><span class="w"> </span><span class="n">f0</span><span class="w"> </span><span class="mf">9f</span><span class="w"> </span><span class="n">e5</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">f0</span><span class="w"> </span><span class="mf">9f</span><span class="w"> </span><span class="n">e5</span><span class="w">  </span><span class="o">|</span><span class="p">................</span><span class="o">|</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="mo">00000050</span><span class="w">  </span><span class="mi">14</span><span class="w"> </span><span class="n">f0</span><span class="w"> </span><span class="mf">9f</span><span class="w"> </span><span class="n">e5</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">f0</span><span class="w"> </span><span class="mf">9f</span><span class="w"> </span><span class="n">e5</span><span class="w">  </span><span class="mi">14</span><span class="w"> </span><span class="n">f0</span><span class="w"> </span><span class="mf">9f</span><span class="w"> </span><span class="n">e5</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">f0</span><span class="w"> </span><span class="mf">9f</span><span class="w"> </span><span class="n">e5</span><span class="w">  </span><span class="o">|</span><span class="p">................</span><span class="o">|</span>
</code></pre></div>
通过对比<code>u-boot.bin</code>头部，我们得知，从 0x00 开始到 0x40 结束的 64字节，就是所谓的<code>legacy image header</code>，也就是上面结构体<code>struct legacy_img_hdr</code>中的内容， 我们将其从flash中读到内存中，定义个指针指向他就好了。在本案例中，<code>ih_load</code>，<code>ih_ep</code>皆为 <code>0x81700000</code></p>
<p>所以，真相大白于天下了，看起来也没那么难，是吧</p>
<h2 id="_5">实现</h2>
<p>我建议看看我在 <a href="https://github.com/ninjar-bsp">ninjar-bsp</a> 中对 <a href="https://github.com/ninjar-bsp/u-boot/tree/ninjar-lite">u-boot</a> 的这两次 commit，比较直观， 但我也会在下面讲实现过程
1. <a href="https://github.com/ninjar-bsp/u-boot/commit/a8f3fe09b3363fec72d73b6a78063b154f39cabd">adding support for booting from spi-nand flash for sunxi.</a>
2. <a href="https://github.com/ninjar-bsp/u-boot/commit/6278f6cc78b0662d0b1b75ea794c728ecefb21ae">f1c100s supportting boot from spi-nand from now !!!</a></p>
<p>第一个提交基本实现了调用到自己<code>spl loader</code>的路径
第二个提交实现了从<code>spi-nand</code>中读出<code>header</code>和<code>u-boot</code></p>
<hr />
<p>好，我们接下来讨论下实现，首先应该从全志的启动源入手，你应该没忘记吧，视线回到这个函数<code>suniv_get_boot_source</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">fel_stash</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">lr</span><span class="p">;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">cpsr</span><span class="p">;</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sctlr</span><span class="p">;</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">vbar</span><span class="p">;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="p">};</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="k">struct</span><span class="w"> </span><span class="nc">fel_stash</span><span class="w"> </span><span class="n">fel_stash</span><span class="w"> </span><span class="n">__section</span><span class="p">(</span><span class="s">&quot;.data&quot;</span><span class="p">);</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">suniv_get_boot_source</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="p">{</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="cm">/* Get the last function call from BootROM&#39;s stack. */</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">brom_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">fel_stash</span><span class="p">.</span><span class="n">sp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">    </span><span class="cm">/* translate SUNIV BootROM stack to standard SUNXI boot sources */</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">brom_call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="p">...</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">    </span><span class="cm">/* SPI NAND is not supported yet. */</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNIV_BOOTED_FROM_NAND</span><span class="p">:</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_INVALID_BOOT_SOURCE</span><span class="p">;</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">    </span><span class="cm">/* If we get here something went wrong try to boot from FEL.*/</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unknown boot source from BROM: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">brom_call</span><span class="p">);</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_INVALID_BOOT_SOURCE</span><span class="p">;</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="p">}</span>
</code></pre></div>
他通过一个指针指向<code>fel_stash.sp - 4</code>的地方，得到了bootrom最后调用的函数，这真的太酷了！
可以看到<code>SUNIV_BOOTED_FROM_NAND</code>分支直接返回了<code>SUNXI_INVALID_BOOT_SOURCE</code>表示无效启动源，所以我们需要改成下面这样
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="cm">/* The low 8-bits of the &#39;boot_media&#39; field in the SPL header */</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="cp">#define SUNXI_BOOTED_FROM_MMC0     0</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="cp">#define SUNXI_BOOTED_FROM_NAND     1</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="cp">#define SUNXI_BOOTED_FROM_MMC2     2</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="cp">#define SUNXI_BOOTED_FROM_SPI      3</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="cp">#define SUNXI_BOOTED_FROM_SPI_NAND 4</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="cm">/*</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="cm"> * Values taken from the F1C200s BootROM stack</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="cm"> * to determine where we booted from.</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="cm"> */</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="cp">#define SUNIV_BOOTED_FROM_MMC0  0xffff40f8</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="cp">#define SUNIV_BOOTED_FROM_NAND  0xffff4114</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="cp">#define SUNIV_BOOTED_FROM_SPI   0xffff4130</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="cp">#define SUNIV_BOOTED_FROM_MMC1  0xffff4150</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="cp">#define SUNIV_BOOTED_FROM_FEL   0xe1a00000</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">suniv_get_boot_source</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="p">{</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">    </span><span class="cm">/* Get the last function call from BootROM&#39;s stack. */</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">brom_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">fel_stash</span><span class="p">.</span><span class="n">sp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="w">    </span><span class="cm">/* translate SUNIV BootROM stack to standard SUNXI boot sources */</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">brom_call</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="p">...</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="w">    </span><span class="cm">/* SPI NAND is not supported yet. */</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNIV_BOOTED_FROM_FEL</span><span class="p">:</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNIV_BOOTED_FROM_NAND</span><span class="p">:</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_BOOTED_FROM_SPI_NAND</span><span class="p">;</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="w">    </span><span class="cm">/* If we get here something went wrong try to boot from FEL.*/</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unknown boot source from BROM: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">brom_call</span><span class="p">);</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SUNXI_INVALID_BOOT_SOURCE</span><span class="p">;</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="p">}</span>
</code></pre></div>
<strong>我为了方便测试，所以把从FEL启动的路径，也重定向到了我的<code>spl loader</code>那里。测试完了后面要删掉，不然影响你原来的FEL loader</strong></p>
<p>宏<code>SUNXI_BOOTED_FROM_SPI_NAND</code>,<code>SUNIV_BOOTED_FROM_FEL</code>位于<code>arch/arm/include/asm/arch-sunxi/spl.h</code>中
之前从 FEL 启动日志里看到会打印从FEL启动的函数地址 <code>0xe1a00000</code>，所以顺手加上了
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>U-Boot SPL 2023.07-rc4ninjar-lite-g1c30e10017-dirty (Jun 19 2023 - 08:33:14 -0400)
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>DRAM: 32 MiB
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>Unknown boot source from BROM: 0xe1a00000
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>Trying to boot from FEL
</code></pre></div></p>
<p>接下来就是修改函数<code>sunxi_get_boot_device</code>，在其中添加对<code>SUNXI_BOOTED_FROM_SPI_NAND</code>的识别，让其返回<code>BOOT_DEVICE_NAND</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="nf">sunxi_get_boot_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="p">{</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">boot_source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sunxi_get_boot_source</span><span class="p">();</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">boot_source</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="p">...</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">SUNXI_BOOTED_FROM_SPI_NAND</span><span class="p">:</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">BOOT_DEVICE_NAND</span><span class="p">;</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unknown boot source %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">boot_source</span><span class="p">);</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">      </span><span class="cm">/* Never reached */</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="p">}</span>
</code></pre></div></p>
<p>很好，启动源转换的部分已经做完了，接下来就是添加一个针对<code>spi-nand</code>的<code>spl loader</code>了</p>
<p>我们在<code>arch/arm/mach-sunxi</code>下新建一个文件<code>spl_spi_nand_sunxi.c</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1">// SPDX-License-Identifier: GPL-2.0+</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="cm">/*</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="cm"> * Copyright (C) 2023 iotah &lt;writeforever@foxmail.com&gt;</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="cm"> */</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;common.h&gt;</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;image.h&gt;</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;malloc.h&gt;</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;log.h&gt;</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;spl.h&gt;</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;hang.h&gt;</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm/arch/spl.h&gt;</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm/gpio.h&gt;</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm/io.h&gt;</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/bitops.h&gt;</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/delay.h&gt;</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/libfdt.h&gt;</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="cp">#ifdef CONFIG_SPL_OS_BOOT</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">    </span><span class="cp">#error CONFIG_SPL_OS_BOOT is not supported yet</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="cp">#endif</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="cm">/*****************************************************************************/</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="cm">/* SUN4I variant of the SPI controller                                       */</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="cm">/*****************************************************************************/</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="cp">#define SUN4I_SPI0_CCTL             0x1C</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="cp">#define SUN4I_SPI0_CTL              0x08</span>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="cp">#define SUN4I_SPI0_RX               0x00</span>
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="cp">#define SUN4I_SPI0_TX               0x04</span>
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="cp">#define SUN4I_SPI0_FIFO_STA         0x28</span>
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="cp">#define SUN4I_SPI0_BC               0x20</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a><span class="cp">#define SUN4I_SPI0_TC               0x24</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a><span class="cp">#define SUN4I_CTL_ENABLE            BIT(0)</span>
<a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a><span class="cp">#define SUN4I_CTL_MASTER            BIT(1)</span>
<a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a><span class="cp">#define SUN4I_CTL_TF_RST            BIT(8)</span>
<a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a><span class="cp">#define SUN4I_CTL_RF_RST            BIT(9)</span>
<a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a><span class="cp">#define SUN4I_CTL_XCH               BIT(10)</span>
<a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a>
<a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a><span class="cm">/*****************************************************************************/</span>
<a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a><span class="cm">/* SUN6I variant of the SPI controller                                       */</span>
<a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a><span class="cm">/*****************************************************************************/</span>
<a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a>
<a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a><span class="cp">#define SUN6I_SPI0_CCTL             0x24</span>
<a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a><span class="cp">#define SUN6I_SPI0_GCR              0x04</span>
<a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a><span class="cp">#define SUN6I_SPI0_TCR              0x08</span>
<a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a><span class="cp">#define SUN6I_SPI0_FIFO_STA         0x1C</span>
<a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a><span class="cp">#define SUN6I_SPI0_MBC              0x30</span>
<a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a><span class="cp">#define SUN6I_SPI0_MTC              0x34</span>
<a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a><span class="cp">#define SUN6I_SPI0_BCC              0x38</span>
<a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a><span class="cp">#define SUN6I_SPI0_TXD              0x200</span>
<a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a><span class="cp">#define SUN6I_SPI0_RXD              0x300</span>
<a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a>
<a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a><span class="cp">#define SUN6I_CTL_ENABLE            BIT(0)</span>
<a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a><span class="cp">#define SUN6I_CTL_MASTER            BIT(1)</span>
<a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a><span class="cp">#define SUN6I_CTL_SRST              BIT(31)</span>
<a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a><span class="cp">#define SUN6I_TCR_XCH               BIT(31)</span>
<a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a>
<a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a><span class="cm">/*****************************************************************************/</span>
<a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a>
<a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a><span class="cp">#define CCM_AHB_GATING0             (0x01C20000 + 0x60)</span>
<a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a><span class="cp">#define CCM_H6_SPI_BGR_REG          (0x03001000 + 0x96c)</span>
<a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a><span class="cp">#ifdef CONFIG_SUN50I_GEN_H6</span>
<a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a><span class="w">    </span><span class="cp">#define CCM_SPI0_CLK                (0x03001000 + 0x940)</span>
<a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a><span class="cp">#else</span>
<a id="__codelineno-19-67" name="__codelineno-19-67" href="#__codelineno-19-67"></a><span class="w">    </span><span class="cp">#define CCM_SPI0_CLK                (0x01C20000 + 0xA0)</span>
<a id="__codelineno-19-68" name="__codelineno-19-68" href="#__codelineno-19-68"></a><span class="cp">#endif</span>
<a id="__codelineno-19-69" name="__codelineno-19-69" href="#__codelineno-19-69"></a><span class="cp">#define SUN6I_BUS_SOFT_RST_REG0     (0x01C20000 + 0x2C0)</span>
<a id="__codelineno-19-70" name="__codelineno-19-70" href="#__codelineno-19-70"></a>
<a id="__codelineno-19-71" name="__codelineno-19-71" href="#__codelineno-19-71"></a><span class="cp">#define AHB_RESET_SPI0_SHIFT        20</span>
<a id="__codelineno-19-72" name="__codelineno-19-72" href="#__codelineno-19-72"></a><span class="cp">#define AHB_GATE_OFFSET_SPI0        20</span>
<a id="__codelineno-19-73" name="__codelineno-19-73" href="#__codelineno-19-73"></a>
<a id="__codelineno-19-74" name="__codelineno-19-74" href="#__codelineno-19-74"></a><span class="cp">#define SPI0_CLK_DIV_BY_2           0x1000</span>
<a id="__codelineno-19-75" name="__codelineno-19-75" href="#__codelineno-19-75"></a><span class="cp">#define SPI0_CLK_DIV_BY_4           0x1001</span>
<a id="__codelineno-19-76" name="__codelineno-19-76" href="#__codelineno-19-76"></a><span class="cp">#define SPI0_CLK_DIV_BY_16          0x1007</span>
<a id="__codelineno-19-77" name="__codelineno-19-77" href="#__codelineno-19-77"></a><span class="cp">#define SPI0_CLK_DIV_BY_32          0x100f</span>
<a id="__codelineno-19-78" name="__codelineno-19-78" href="#__codelineno-19-78"></a><span class="cp">#define SPI0_CLK_DIV_BY_64          0x600</span>
<a id="__codelineno-19-79" name="__codelineno-19-79" href="#__codelineno-19-79"></a>
<a id="__codelineno-19-80" name="__codelineno-19-80" href="#__codelineno-19-80"></a><span class="cp">#define SPI_READ_MAX_SIZE 64 </span><span class="cm">/* FIFO size, minus 4 bytes of the header */</span>
<a id="__codelineno-19-81" name="__codelineno-19-81" href="#__codelineno-19-81"></a>
<a id="__codelineno-19-82" name="__codelineno-19-82" href="#__codelineno-19-82"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi_reg_offsets</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-83" name="__codelineno-19-83" href="#__codelineno-19-83"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_ctl_reg</span><span class="p">;</span>
<a id="__codelineno-19-84" name="__codelineno-19-84" href="#__codelineno-19-84"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_ctl_xch_bitmask</span><span class="p">;</span>
<a id="__codelineno-19-85" name="__codelineno-19-85" href="#__codelineno-19-85"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_fifo_reg</span><span class="p">;</span>
<a id="__codelineno-19-86" name="__codelineno-19-86" href="#__codelineno-19-86"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_tx_reg</span><span class="p">;</span>
<a id="__codelineno-19-87" name="__codelineno-19-87" href="#__codelineno-19-87"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_rx_reg</span><span class="p">;</span>
<a id="__codelineno-19-88" name="__codelineno-19-88" href="#__codelineno-19-88"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_bc_reg</span><span class="p">;</span>
<a id="__codelineno-19-89" name="__codelineno-19-89" href="#__codelineno-19-89"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_tc_reg</span><span class="p">;</span>
<a id="__codelineno-19-90" name="__codelineno-19-90" href="#__codelineno-19-90"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_bcc_reg</span><span class="p">;</span>
<a id="__codelineno-19-91" name="__codelineno-19-91" href="#__codelineno-19-91"></a><span class="p">};</span>
<a id="__codelineno-19-92" name="__codelineno-19-92" href="#__codelineno-19-92"></a>
<a id="__codelineno-19-93" name="__codelineno-19-93" href="#__codelineno-19-93"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi_reg_offsets</span><span class="w"> </span><span class="n">sun6i_spi_reg_offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-94" name="__codelineno-19-94" href="#__codelineno-19-94"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_ctl_reg</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">SUN6I_SPI0_TCR</span><span class="p">,</span>
<a id="__codelineno-19-95" name="__codelineno-19-95" href="#__codelineno-19-95"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_fifo_reg</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">SUN6I_SPI0_FIFO_STA</span><span class="p">,</span>
<a id="__codelineno-19-96" name="__codelineno-19-96" href="#__codelineno-19-96"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_tx_reg</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">SUN6I_SPI0_TXD</span><span class="p">,</span>
<a id="__codelineno-19-97" name="__codelineno-19-97" href="#__codelineno-19-97"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_rx_reg</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">SUN6I_SPI0_RXD</span><span class="p">,</span>
<a id="__codelineno-19-98" name="__codelineno-19-98" href="#__codelineno-19-98"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_bc_reg</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">SUN6I_SPI0_MBC</span><span class="p">,</span>
<a id="__codelineno-19-99" name="__codelineno-19-99" href="#__codelineno-19-99"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_tc_reg</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">SUN6I_SPI0_MTC</span><span class="p">,</span>
<a id="__codelineno-19-100" name="__codelineno-19-100" href="#__codelineno-19-100"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_bcc_reg</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">SUN6I_SPI0_BCC</span><span class="p">,</span>
<a id="__codelineno-19-101" name="__codelineno-19-101" href="#__codelineno-19-101"></a><span class="p">};</span>
<a id="__codelineno-19-102" name="__codelineno-19-102" href="#__codelineno-19-102"></a>
<a id="__codelineno-19-103" name="__codelineno-19-103" href="#__codelineno-19-103"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi_reg_offsets</span><span class="w"> </span><span class="n">sun4i_spi_reg_offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-104" name="__codelineno-19-104" href="#__codelineno-19-104"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_ctl_reg</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">SUN4I_SPI0_CTL</span><span class="p">,</span>
<a id="__codelineno-19-105" name="__codelineno-19-105" href="#__codelineno-19-105"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_fifo_reg</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">SUN4I_SPI0_FIFO_STA</span><span class="p">,</span>
<a id="__codelineno-19-106" name="__codelineno-19-106" href="#__codelineno-19-106"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_tx_reg</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">SUN4I_SPI0_TX</span><span class="p">,</span>
<a id="__codelineno-19-107" name="__codelineno-19-107" href="#__codelineno-19-107"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_rx_reg</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">SUN4I_SPI0_RX</span><span class="p">,</span>
<a id="__codelineno-19-108" name="__codelineno-19-108" href="#__codelineno-19-108"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_bc_reg</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">SUN4I_SPI0_BC</span><span class="p">,</span>
<a id="__codelineno-19-109" name="__codelineno-19-109" href="#__codelineno-19-109"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_tc_reg</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">SUN4I_SPI0_TC</span><span class="p">,</span>
<a id="__codelineno-19-110" name="__codelineno-19-110" href="#__codelineno-19-110"></a><span class="w">    </span><span class="p">.</span><span class="n">spi_bcc_reg</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-19-111" name="__codelineno-19-111" href="#__codelineno-19-111"></a><span class="p">};</span>
<a id="__codelineno-19-112" name="__codelineno-19-112" href="#__codelineno-19-112"></a><span class="cp">#define to_sunxi_spi_reg(spi, reg) \</span>
<a id="__codelineno-19-113" name="__codelineno-19-113" href="#__codelineno-19-113"></a><span class="cp">    (spi-&gt;base + spi-&gt;reg_offsets-&gt;spi_##reg)</span>
<a id="__codelineno-19-114" name="__codelineno-19-114" href="#__codelineno-19-114"></a>
<a id="__codelineno-19-115" name="__codelineno-19-115" href="#__codelineno-19-115"></a><span class="k">struct</span><span class="w"> </span><span class="nc">spi_nand_device</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-116" name="__codelineno-19-116" href="#__codelineno-19-116"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-19-117" name="__codelineno-19-117" href="#__codelineno-19-117"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">page</span><span class="p">;</span>
<a id="__codelineno-19-118" name="__codelineno-19-118" href="#__codelineno-19-118"></a>
<a id="__codelineno-19-119" name="__codelineno-19-119" href="#__codelineno-19-119"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">page_size</span><span class="p">;</span>
<a id="__codelineno-19-120" name="__codelineno-19-120" href="#__codelineno-19-120"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">block_size</span><span class="p">;</span>
<a id="__codelineno-19-121" name="__codelineno-19-121" href="#__codelineno-19-121"></a><span class="p">};</span>
<a id="__codelineno-19-122" name="__codelineno-19-122" href="#__codelineno-19-122"></a>
<a id="__codelineno-19-123" name="__codelineno-19-123" href="#__codelineno-19-123"></a><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-124" name="__codelineno-19-124" href="#__codelineno-19-124"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<a id="__codelineno-19-125" name="__codelineno-19-125" href="#__codelineno-19-125"></a>
<a id="__codelineno-19-126" name="__codelineno-19-126" href="#__codelineno-19-126"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">fifo_depth</span><span class="p">;</span>
<a id="__codelineno-19-127" name="__codelineno-19-127" href="#__codelineno-19-127"></a>
<a id="__codelineno-19-128" name="__codelineno-19-128" href="#__codelineno-19-128"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_sun6i</span><span class="p">;</span>
<a id="__codelineno-19-129" name="__codelineno-19-129" href="#__codelineno-19-129"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi_reg_offsets</span><span class="w"> </span><span class="o">*</span><span class="n">reg_offsets</span><span class="p">;</span>
<a id="__codelineno-19-130" name="__codelineno-19-130" href="#__codelineno-19-130"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_ctl_xch_bitmask</span><span class="p">;</span>
<a id="__codelineno-19-131" name="__codelineno-19-131" href="#__codelineno-19-131"></a>
<a id="__codelineno-19-132" name="__codelineno-19-132" href="#__codelineno-19-132"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">spi_nand_device</span><span class="w"> </span><span class="n">nand_dev</span><span class="p">;</span>
<a id="__codelineno-19-133" name="__codelineno-19-133" href="#__codelineno-19-133"></a><span class="p">};</span>
<a id="__codelineno-19-134" name="__codelineno-19-134" href="#__codelineno-19-134"></a>
<a id="__codelineno-19-135" name="__codelineno-19-135" href="#__codelineno-19-135"></a><span class="cm">/*****************************************************************************/</span>
<a id="__codelineno-19-136" name="__codelineno-19-136" href="#__codelineno-19-136"></a><span class="cm">/* Winbond SPI NAND Instructions Table                                     */</span>
<a id="__codelineno-19-137" name="__codelineno-19-137" href="#__codelineno-19-137"></a><span class="cm">/*****************************************************************************/</span>
<a id="__codelineno-19-138" name="__codelineno-19-138" href="#__codelineno-19-138"></a><span class="cp">#define SPI_NAND_RESET          0xff    </span><span class="cm">/* device reset */</span>
<a id="__codelineno-19-139" name="__codelineno-19-139" href="#__codelineno-19-139"></a><span class="cp">#define SPI_NAND_RD_ID          0x9f    </span><span class="cm">/* read jedec id */</span>
<a id="__codelineno-19-140" name="__codelineno-19-140" href="#__codelineno-19-140"></a><span class="cp">#define SPI_NAND_RD_STAT_REG    0x0f    </span><span class="cm">/* read status register */</span>
<a id="__codelineno-19-141" name="__codelineno-19-141" href="#__codelineno-19-141"></a><span class="cp">#define SPI_NAND_WD_STAT_REG    0x1f    </span><span class="cm">/* write status register */</span>
<a id="__codelineno-19-142" name="__codelineno-19-142" href="#__codelineno-19-142"></a><span class="cp">#define SPI_NAND_WD_ON          0x06    </span><span class="cm">/* write enable */</span>
<a id="__codelineno-19-143" name="__codelineno-19-143" href="#__codelineno-19-143"></a><span class="cp">#define SPI_NAND_WD_OFF         0x04    </span><span class="cm">/* write disable */</span>
<a id="__codelineno-19-144" name="__codelineno-19-144" href="#__codelineno-19-144"></a><span class="cp">#define SPI_NAND_RD_PAGE_DATA   0x13    </span><span class="cm">/* read page into data buffer */</span>
<a id="__codelineno-19-145" name="__codelineno-19-145" href="#__codelineno-19-145"></a><span class="cp">#define SPI_NAND_RD_DATA        0x03    </span><span class="cm">/* read from data buffer */</span>
<a id="__codelineno-19-146" name="__codelineno-19-146" href="#__codelineno-19-146"></a>
<a id="__codelineno-19-147" name="__codelineno-19-147" href="#__codelineno-19-147"></a><span class="cm">/*****************************************************************************/</span>
<a id="__codelineno-19-148" name="__codelineno-19-148" href="#__codelineno-19-148"></a>
<a id="__codelineno-19-149" name="__codelineno-19-149" href="#__codelineno-19-149"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__maybe_unused</span><span class="w"> </span><span class="nf">hexdump</span><span class="p">(</span><span class="n">ulong</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dump_len</span><span class="p">)</span>
<a id="__codelineno-19-150" name="__codelineno-19-150" href="#__codelineno-19-150"></a><span class="p">{</span>
<a id="__codelineno-19-151" name="__codelineno-19-151" href="#__codelineno-19-151"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
<a id="__codelineno-19-152" name="__codelineno-19-152" href="#__codelineno-19-152"></a>
<a id="__codelineno-19-153" name="__codelineno-19-153" href="#__codelineno-19-153"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">data_per_line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="__codelineno-19-154" name="__codelineno-19-154" href="#__codelineno-19-154"></a>
<a id="__codelineno-19-155" name="__codelineno-19-155" href="#__codelineno-19-155"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dump_len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-156" name="__codelineno-19-156" href="#__codelineno-19-156"></a>
<a id="__codelineno-19-157" name="__codelineno-19-157" href="#__codelineno-19-157"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">data_per_line</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-158" name="__codelineno-19-158" href="#__codelineno-19-158"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-19-159" name="__codelineno-19-159" href="#__codelineno-19-159"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-160" name="__codelineno-19-160" href="#__codelineno-19-160"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">data_per_line</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-161" name="__codelineno-19-161" href="#__codelineno-19-161"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%08x&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">));</span>
<a id="__codelineno-19-162" name="__codelineno-19-162" href="#__codelineno-19-162"></a><span class="w">            </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data_per_line</span><span class="p">;</span>
<a id="__codelineno-19-163" name="__codelineno-19-163" href="#__codelineno-19-163"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-19-164" name="__codelineno-19-164" href="#__codelineno-19-164"></a>
<a id="__codelineno-19-165" name="__codelineno-19-165" href="#__codelineno-19-165"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-19-166" name="__codelineno-19-166" href="#__codelineno-19-166"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
<a id="__codelineno-19-167" name="__codelineno-19-167" href="#__codelineno-19-167"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-19-168" name="__codelineno-19-168" href="#__codelineno-19-168"></a><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %02x&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>
<a id="__codelineno-19-169" name="__codelineno-19-169" href="#__codelineno-19-169"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-170" name="__codelineno-19-170" href="#__codelineno-19-170"></a>
<a id="__codelineno-19-171" name="__codelineno-19-171" href="#__codelineno-19-171"></a><span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-19-172" name="__codelineno-19-172" href="#__codelineno-19-172"></a>
<a id="__codelineno-19-173" name="__codelineno-19-173" href="#__codelineno-19-173"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-174" name="__codelineno-19-174" href="#__codelineno-19-174"></a><span class="p">}</span>
<a id="__codelineno-19-175" name="__codelineno-19-175" href="#__codelineno-19-175"></a>
<a id="__codelineno-19-176" name="__codelineno-19-176" href="#__codelineno-19-176"></a><span class="cm">/*</span>
<a id="__codelineno-19-177" name="__codelineno-19-177" href="#__codelineno-19-177"></a><span class="cm"> * Allwinner A10/A20 SoCs were using pins PC0,PC1,PC2,PC23 for booting</span>
<a id="__codelineno-19-178" name="__codelineno-19-178" href="#__codelineno-19-178"></a><span class="cm"> * from SPI Flash, everything else is using pins PC0,PC1,PC2,PC3.</span>
<a id="__codelineno-19-179" name="__codelineno-19-179" href="#__codelineno-19-179"></a><span class="cm"> * The H6 uses PC0, PC2, PC3, PC5, the H616 PC0, PC2, PC3, PC4.</span>
<a id="__codelineno-19-180" name="__codelineno-19-180" href="#__codelineno-19-180"></a><span class="cm"> */</span>
<a id="__codelineno-19-181" name="__codelineno-19-181" href="#__codelineno-19-181"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">spi0_pinmux_setup</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pin_function</span><span class="p">)</span>
<a id="__codelineno-19-182" name="__codelineno-19-182" href="#__codelineno-19-182"></a><span class="p">{</span>
<a id="__codelineno-19-183" name="__codelineno-19-183" href="#__codelineno-19-183"></a><span class="w">    </span><span class="cm">/* All chips use PC0 and PC2. */</span>
<a id="__codelineno-19-184" name="__codelineno-19-184" href="#__codelineno-19-184"></a><span class="w">    </span><span class="n">sunxi_gpio_set_cfgpin</span><span class="p">(</span><span class="n">SUNXI_GPC</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">pin_function</span><span class="p">);</span>
<a id="__codelineno-19-185" name="__codelineno-19-185" href="#__codelineno-19-185"></a><span class="w">    </span><span class="n">sunxi_gpio_set_cfgpin</span><span class="p">(</span><span class="n">SUNXI_GPC</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">pin_function</span><span class="p">);</span>
<a id="__codelineno-19-186" name="__codelineno-19-186" href="#__codelineno-19-186"></a>
<a id="__codelineno-19-187" name="__codelineno-19-187" href="#__codelineno-19-187"></a><span class="w">    </span><span class="cm">/* All chips except H6 and H616 use PC1. */</span>
<a id="__codelineno-19-188" name="__codelineno-19-188" href="#__codelineno-19-188"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SUN50I_GEN_H6</span><span class="p">))</span>
<a id="__codelineno-19-189" name="__codelineno-19-189" href="#__codelineno-19-189"></a><span class="w">        </span><span class="n">sunxi_gpio_set_cfgpin</span><span class="p">(</span><span class="n">SUNXI_GPC</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">pin_function</span><span class="p">);</span>
<a id="__codelineno-19-190" name="__codelineno-19-190" href="#__codelineno-19-190"></a>
<a id="__codelineno-19-191" name="__codelineno-19-191" href="#__codelineno-19-191"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUN50I_H6</span><span class="p">))</span>
<a id="__codelineno-19-192" name="__codelineno-19-192" href="#__codelineno-19-192"></a><span class="w">        </span><span class="n">sunxi_gpio_set_cfgpin</span><span class="p">(</span><span class="n">SUNXI_GPC</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="n">pin_function</span><span class="p">);</span>
<a id="__codelineno-19-193" name="__codelineno-19-193" href="#__codelineno-19-193"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUN50I_H616</span><span class="p">))</span>
<a id="__codelineno-19-194" name="__codelineno-19-194" href="#__codelineno-19-194"></a><span class="w">        </span><span class="n">sunxi_gpio_set_cfgpin</span><span class="p">(</span><span class="n">SUNXI_GPC</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="n">pin_function</span><span class="p">);</span>
<a id="__codelineno-19-195" name="__codelineno-19-195" href="#__codelineno-19-195"></a>
<a id="__codelineno-19-196" name="__codelineno-19-196" href="#__codelineno-19-196"></a><span class="w">    </span><span class="cm">/* Older generations use PC23 for CS, newer ones use PC3. */</span>
<a id="__codelineno-19-197" name="__codelineno-19-197" href="#__codelineno-19-197"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUN4I</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUN7I</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-19-198" name="__codelineno-19-198" href="#__codelineno-19-198"></a><span class="w">        </span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUN8I_R40</span><span class="p">))</span>
<a id="__codelineno-19-199" name="__codelineno-19-199" href="#__codelineno-19-199"></a><span class="w">        </span><span class="n">sunxi_gpio_set_cfgpin</span><span class="p">(</span><span class="n">SUNXI_GPC</span><span class="p">(</span><span class="mi">23</span><span class="p">),</span><span class="w"> </span><span class="n">pin_function</span><span class="p">);</span>
<a id="__codelineno-19-200" name="__codelineno-19-200" href="#__codelineno-19-200"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-19-201" name="__codelineno-19-201" href="#__codelineno-19-201"></a><span class="w">        </span><span class="n">sunxi_gpio_set_cfgpin</span><span class="p">(</span><span class="n">SUNXI_GPC</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="n">pin_function</span><span class="p">);</span>
<a id="__codelineno-19-202" name="__codelineno-19-202" href="#__codelineno-19-202"></a><span class="p">}</span>
<a id="__codelineno-19-203" name="__codelineno-19-203" href="#__codelineno-19-203"></a>
<a id="__codelineno-19-204" name="__codelineno-19-204" href="#__codelineno-19-204"></a><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">is_sun6i_gen_spi</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-19-205" name="__codelineno-19-205" href="#__codelineno-19-205"></a><span class="p">{</span>
<a id="__codelineno-19-206" name="__codelineno-19-206" href="#__codelineno-19-206"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SUNXI_GEN_SUN6I</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-19-207" name="__codelineno-19-207" href="#__codelineno-19-207"></a><span class="w">           </span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SUN50I_GEN_H6</span><span class="p">);</span>
<a id="__codelineno-19-208" name="__codelineno-19-208" href="#__codelineno-19-208"></a><span class="p">}</span>
<a id="__codelineno-19-209" name="__codelineno-19-209" href="#__codelineno-19-209"></a>
<a id="__codelineno-19-210" name="__codelineno-19-210" href="#__codelineno-19-210"></a><span class="k">static</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="nf">spi0_base_address</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-19-211" name="__codelineno-19-211" href="#__codelineno-19-211"></a><span class="p">{</span>
<a id="__codelineno-19-212" name="__codelineno-19-212" href="#__codelineno-19-212"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUN8I_R40</span><span class="p">))</span>
<a id="__codelineno-19-213" name="__codelineno-19-213" href="#__codelineno-19-213"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0x01C05000</span><span class="p">;</span>
<a id="__codelineno-19-214" name="__codelineno-19-214" href="#__codelineno-19-214"></a>
<a id="__codelineno-19-215" name="__codelineno-19-215" href="#__codelineno-19-215"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SUN50I_GEN_H6</span><span class="p">))</span>
<a id="__codelineno-19-216" name="__codelineno-19-216" href="#__codelineno-19-216"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0x05010000</span><span class="p">;</span>
<a id="__codelineno-19-217" name="__codelineno-19-217" href="#__codelineno-19-217"></a>
<a id="__codelineno-19-218" name="__codelineno-19-218" href="#__codelineno-19-218"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">is_sun6i_gen_spi</span><span class="p">()</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-19-219" name="__codelineno-19-219" href="#__codelineno-19-219"></a><span class="w">        </span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUNIV</span><span class="p">))</span>
<a id="__codelineno-19-220" name="__codelineno-19-220" href="#__codelineno-19-220"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mh">0x01C05000</span><span class="p">;</span>
<a id="__codelineno-19-221" name="__codelineno-19-221" href="#__codelineno-19-221"></a>
<a id="__codelineno-19-222" name="__codelineno-19-222" href="#__codelineno-19-222"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mh">0x01C68000</span><span class="p">;</span>
<a id="__codelineno-19-223" name="__codelineno-19-223" href="#__codelineno-19-223"></a><span class="p">}</span>
<a id="__codelineno-19-224" name="__codelineno-19-224" href="#__codelineno-19-224"></a>
<a id="__codelineno-19-225" name="__codelineno-19-225" href="#__codelineno-19-225"></a><span class="cm">/*</span>
<a id="__codelineno-19-226" name="__codelineno-19-226" href="#__codelineno-19-226"></a><span class="cm"> * Setup 6 MHz from OSC24M (because the BROM is doing the same).</span>
<a id="__codelineno-19-227" name="__codelineno-19-227" href="#__codelineno-19-227"></a><span class="cm"> */</span>
<a id="__codelineno-19-228" name="__codelineno-19-228" href="#__codelineno-19-228"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">spi0_enable_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-19-229" name="__codelineno-19-229" href="#__codelineno-19-229"></a><span class="p">{</span>
<a id="__codelineno-19-230" name="__codelineno-19-230" href="#__codelineno-19-230"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi0_base_address</span><span class="p">();</span>
<a id="__codelineno-19-231" name="__codelineno-19-231" href="#__codelineno-19-231"></a>
<a id="__codelineno-19-232" name="__codelineno-19-232" href="#__codelineno-19-232"></a><span class="w">    </span><span class="cm">/* Deassert SPI0 reset on SUN6I */</span>
<a id="__codelineno-19-233" name="__codelineno-19-233" href="#__codelineno-19-233"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SUN50I_GEN_H6</span><span class="p">))</span>
<a id="__codelineno-19-234" name="__codelineno-19-234" href="#__codelineno-19-234"></a><span class="w">        </span><span class="n">setbits_le32</span><span class="p">(</span><span class="n">CCM_H6_SPI_BGR_REG</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>
<a id="__codelineno-19-235" name="__codelineno-19-235" href="#__codelineno-19-235"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_sun6i_gen_spi</span><span class="p">())</span>
<a id="__codelineno-19-236" name="__codelineno-19-236" href="#__codelineno-19-236"></a><span class="w">        </span><span class="n">setbits_le32</span><span class="p">(</span><span class="n">SUN6I_BUS_SOFT_RST_REG0</span><span class="p">,</span>
<a id="__codelineno-19-237" name="__codelineno-19-237" href="#__codelineno-19-237"></a><span class="w">                     </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">AHB_RESET_SPI0_SHIFT</span><span class="p">));</span>
<a id="__codelineno-19-238" name="__codelineno-19-238" href="#__codelineno-19-238"></a>
<a id="__codelineno-19-239" name="__codelineno-19-239" href="#__codelineno-19-239"></a><span class="w">    </span><span class="cm">/* Open the SPI0 gate */</span>
<a id="__codelineno-19-240" name="__codelineno-19-240" href="#__codelineno-19-240"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SUN50I_GEN_H6</span><span class="p">))</span>
<a id="__codelineno-19-241" name="__codelineno-19-241" href="#__codelineno-19-241"></a><span class="w">        </span><span class="n">setbits_le32</span><span class="p">(</span><span class="n">CCM_AHB_GATING0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">AHB_GATE_OFFSET_SPI0</span><span class="p">));</span>
<a id="__codelineno-19-242" name="__codelineno-19-242" href="#__codelineno-19-242"></a>
<a id="__codelineno-19-243" name="__codelineno-19-243" href="#__codelineno-19-243"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUNIV</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-244" name="__codelineno-19-244" href="#__codelineno-19-244"></a><span class="w">        </span><span class="cm">/* Divide by 32, clock source is AHB clock 200MHz */</span>
<a id="__codelineno-19-245" name="__codelineno-19-245" href="#__codelineno-19-245"></a><span class="w">        </span><span class="n">writel</span><span class="p">(</span><span class="n">SPI0_CLK_DIV_BY_64</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SUN6I_SPI0_CCTL</span><span class="p">);</span>
<a id="__codelineno-19-246" name="__codelineno-19-246" href="#__codelineno-19-246"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-247" name="__codelineno-19-247" href="#__codelineno-19-247"></a><span class="w">        </span><span class="cm">/* Divide by 4 */</span>
<a id="__codelineno-19-248" name="__codelineno-19-248" href="#__codelineno-19-248"></a><span class="w">        </span><span class="n">writel</span><span class="p">(</span><span class="n">SPI0_CLK_DIV_BY_4</span><span class="p">,</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">is_sun6i_gen_spi</span><span class="p">()</span><span class="w"> </span><span class="o">?</span>
<a id="__codelineno-19-249" name="__codelineno-19-249" href="#__codelineno-19-249"></a><span class="w">                                          </span><span class="nl">SUN6I_SPI0_CCTL</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">SUN4I_SPI0_CCTL</span><span class="p">));</span>
<a id="__codelineno-19-250" name="__codelineno-19-250" href="#__codelineno-19-250"></a><span class="w">        </span><span class="cm">/* 24MHz from OSC24M */</span>
<a id="__codelineno-19-251" name="__codelineno-19-251" href="#__codelineno-19-251"></a><span class="w">        </span><span class="n">writel</span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">31</span><span class="p">),</span><span class="w"> </span><span class="n">CCM_SPI0_CLK</span><span class="p">);</span>
<a id="__codelineno-19-252" name="__codelineno-19-252" href="#__codelineno-19-252"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-253" name="__codelineno-19-253" href="#__codelineno-19-253"></a>
<a id="__codelineno-19-254" name="__codelineno-19-254" href="#__codelineno-19-254"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_sun6i_gen_spi</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-255" name="__codelineno-19-255" href="#__codelineno-19-255"></a><span class="w">        </span><span class="cm">/* Enable SPI in the master mode and do a soft reset */</span>
<a id="__codelineno-19-256" name="__codelineno-19-256" href="#__codelineno-19-256"></a><span class="w">        </span><span class="n">setbits_le32</span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SUN6I_SPI0_GCR</span><span class="p">,</span><span class="w"> </span><span class="n">SUN6I_CTL_MASTER</span><span class="w"> </span><span class="o">|</span>
<a id="__codelineno-19-257" name="__codelineno-19-257" href="#__codelineno-19-257"></a><span class="w">                     </span><span class="n">SUN6I_CTL_ENABLE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SUN6I_CTL_SRST</span><span class="p">);</span>
<a id="__codelineno-19-258" name="__codelineno-19-258" href="#__codelineno-19-258"></a><span class="w">        </span><span class="cm">/* Wait for completion */</span>
<a id="__codelineno-19-259" name="__codelineno-19-259" href="#__codelineno-19-259"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SUN6I_SPI0_GCR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SUN6I_CTL_SRST</span><span class="p">)</span>
<a id="__codelineno-19-260" name="__codelineno-19-260" href="#__codelineno-19-260"></a><span class="w">            </span><span class="p">;</span>
<a id="__codelineno-19-261" name="__codelineno-19-261" href="#__codelineno-19-261"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-262" name="__codelineno-19-262" href="#__codelineno-19-262"></a><span class="w">        </span><span class="cm">/* Enable SPI in the master mode and reset FIFO */</span>
<a id="__codelineno-19-263" name="__codelineno-19-263" href="#__codelineno-19-263"></a><span class="w">        </span><span class="n">setbits_le32</span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SUN4I_SPI0_CTL</span><span class="p">,</span><span class="w"> </span><span class="n">SUN4I_CTL_MASTER</span><span class="w"> </span><span class="o">|</span>
<a id="__codelineno-19-264" name="__codelineno-19-264" href="#__codelineno-19-264"></a><span class="w">                     </span><span class="n">SUN4I_CTL_ENABLE</span><span class="w"> </span><span class="o">|</span>
<a id="__codelineno-19-265" name="__codelineno-19-265" href="#__codelineno-19-265"></a><span class="w">                     </span><span class="n">SUN4I_CTL_TF_RST</span><span class="w"> </span><span class="o">|</span>
<a id="__codelineno-19-266" name="__codelineno-19-266" href="#__codelineno-19-266"></a><span class="w">                     </span><span class="n">SUN4I_CTL_RF_RST</span><span class="p">);</span>
<a id="__codelineno-19-267" name="__codelineno-19-267" href="#__codelineno-19-267"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-268" name="__codelineno-19-268" href="#__codelineno-19-268"></a><span class="p">}</span>
<a id="__codelineno-19-269" name="__codelineno-19-269" href="#__codelineno-19-269"></a>
<a id="__codelineno-19-270" name="__codelineno-19-270" href="#__codelineno-19-270"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">spi0_disable_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-19-271" name="__codelineno-19-271" href="#__codelineno-19-271"></a><span class="p">{</span>
<a id="__codelineno-19-272" name="__codelineno-19-272" href="#__codelineno-19-272"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi0_base_address</span><span class="p">();</span>
<a id="__codelineno-19-273" name="__codelineno-19-273" href="#__codelineno-19-273"></a>
<a id="__codelineno-19-274" name="__codelineno-19-274" href="#__codelineno-19-274"></a><span class="w">    </span><span class="cm">/* Disable the SPI0 controller */</span>
<a id="__codelineno-19-275" name="__codelineno-19-275" href="#__codelineno-19-275"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_sun6i_gen_spi</span><span class="p">())</span>
<a id="__codelineno-19-276" name="__codelineno-19-276" href="#__codelineno-19-276"></a><span class="w">        </span><span class="n">clrbits_le32</span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SUN6I_SPI0_GCR</span><span class="p">,</span><span class="w"> </span><span class="n">SUN6I_CTL_MASTER</span><span class="w"> </span><span class="o">|</span>
<a id="__codelineno-19-277" name="__codelineno-19-277" href="#__codelineno-19-277"></a><span class="w">                     </span><span class="n">SUN6I_CTL_ENABLE</span><span class="p">);</span>
<a id="__codelineno-19-278" name="__codelineno-19-278" href="#__codelineno-19-278"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-19-279" name="__codelineno-19-279" href="#__codelineno-19-279"></a><span class="w">        </span><span class="n">clrbits_le32</span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SUN4I_SPI0_CTL</span><span class="p">,</span><span class="w"> </span><span class="n">SUN4I_CTL_MASTER</span><span class="w"> </span><span class="o">|</span>
<a id="__codelineno-19-280" name="__codelineno-19-280" href="#__codelineno-19-280"></a><span class="w">                     </span><span class="n">SUN4I_CTL_ENABLE</span><span class="p">);</span>
<a id="__codelineno-19-281" name="__codelineno-19-281" href="#__codelineno-19-281"></a>
<a id="__codelineno-19-282" name="__codelineno-19-282" href="#__codelineno-19-282"></a><span class="w">    </span><span class="cm">/* Disable the SPI0 clock */</span>
<a id="__codelineno-19-283" name="__codelineno-19-283" href="#__codelineno-19-283"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUNIV</span><span class="p">))</span>
<a id="__codelineno-19-284" name="__codelineno-19-284" href="#__codelineno-19-284"></a><span class="w">        </span><span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">CCM_SPI0_CLK</span><span class="p">);</span>
<a id="__codelineno-19-285" name="__codelineno-19-285" href="#__codelineno-19-285"></a>
<a id="__codelineno-19-286" name="__codelineno-19-286" href="#__codelineno-19-286"></a><span class="w">    </span><span class="cm">/* Close the SPI0 gate */</span>
<a id="__codelineno-19-287" name="__codelineno-19-287" href="#__codelineno-19-287"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SUN50I_GEN_H6</span><span class="p">))</span>
<a id="__codelineno-19-288" name="__codelineno-19-288" href="#__codelineno-19-288"></a><span class="w">        </span><span class="n">clrbits_le32</span><span class="p">(</span><span class="n">CCM_AHB_GATING0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">AHB_GATE_OFFSET_SPI0</span><span class="p">));</span>
<a id="__codelineno-19-289" name="__codelineno-19-289" href="#__codelineno-19-289"></a>
<a id="__codelineno-19-290" name="__codelineno-19-290" href="#__codelineno-19-290"></a><span class="w">    </span><span class="cm">/* Assert SPI0 reset on SUN6I */</span>
<a id="__codelineno-19-291" name="__codelineno-19-291" href="#__codelineno-19-291"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SUN50I_GEN_H6</span><span class="p">))</span>
<a id="__codelineno-19-292" name="__codelineno-19-292" href="#__codelineno-19-292"></a><span class="w">        </span><span class="n">clrbits_le32</span><span class="p">(</span><span class="n">CCM_H6_SPI_BGR_REG</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x1</span><span class="p">);</span>
<a id="__codelineno-19-293" name="__codelineno-19-293" href="#__codelineno-19-293"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_sun6i_gen_spi</span><span class="p">())</span>
<a id="__codelineno-19-294" name="__codelineno-19-294" href="#__codelineno-19-294"></a><span class="w">        </span><span class="n">clrbits_le32</span><span class="p">(</span><span class="n">SUN6I_BUS_SOFT_RST_REG0</span><span class="p">,</span>
<a id="__codelineno-19-295" name="__codelineno-19-295" href="#__codelineno-19-295"></a><span class="w">                     </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">AHB_RESET_SPI0_SHIFT</span><span class="p">));</span>
<a id="__codelineno-19-296" name="__codelineno-19-296" href="#__codelineno-19-296"></a><span class="p">}</span>
<a id="__codelineno-19-297" name="__codelineno-19-297" href="#__codelineno-19-297"></a>
<a id="__codelineno-19-298" name="__codelineno-19-298" href="#__codelineno-19-298"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">spi0_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<a id="__codelineno-19-299" name="__codelineno-19-299" href="#__codelineno-19-299"></a><span class="p">{</span>
<a id="__codelineno-19-300" name="__codelineno-19-300" href="#__codelineno-19-300"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pin_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SUNXI_GPC_SPI0</span><span class="p">;</span>
<a id="__codelineno-19-301" name="__codelineno-19-301" href="#__codelineno-19-301"></a>
<a id="__codelineno-19-302" name="__codelineno-19-302" href="#__codelineno-19-302"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUN50I</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-19-303" name="__codelineno-19-303" href="#__codelineno-19-303"></a><span class="w">        </span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SUN50I_GEN_H6</span><span class="p">))</span>
<a id="__codelineno-19-304" name="__codelineno-19-304" href="#__codelineno-19-304"></a><span class="w">        </span><span class="n">pin_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SUN50I_GPC_SPI0</span><span class="p">;</span>
<a id="__codelineno-19-305" name="__codelineno-19-305" href="#__codelineno-19-305"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_MACH_SUNIV</span><span class="p">))</span>
<a id="__codelineno-19-306" name="__codelineno-19-306" href="#__codelineno-19-306"></a><span class="w">        </span><span class="n">pin_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SUNIV_GPC_SPI0</span><span class="p">;</span>
<a id="__codelineno-19-307" name="__codelineno-19-307" href="#__codelineno-19-307"></a>
<a id="__codelineno-19-308" name="__codelineno-19-308" href="#__codelineno-19-308"></a><span class="w">    </span><span class="n">spi0_pinmux_setup</span><span class="p">(</span><span class="n">pin_function</span><span class="p">);</span>
<a id="__codelineno-19-309" name="__codelineno-19-309" href="#__codelineno-19-309"></a><span class="w">    </span><span class="n">spi0_enable_clock</span><span class="p">();</span>
<a id="__codelineno-19-310" name="__codelineno-19-310" href="#__codelineno-19-310"></a>
<a id="__codelineno-19-311" name="__codelineno-19-311" href="#__codelineno-19-311"></a><span class="w">    </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi0_base_address</span><span class="p">();</span>
<a id="__codelineno-19-312" name="__codelineno-19-312" href="#__codelineno-19-312"></a><span class="w">    </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">is_sun6i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_sun6i_gen_spi</span><span class="p">();</span>
<a id="__codelineno-19-313" name="__codelineno-19-313" href="#__codelineno-19-313"></a><span class="w">    </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">fifo_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SPI_READ_MAX_SIZE</span><span class="p">;</span>
<a id="__codelineno-19-314" name="__codelineno-19-314" href="#__codelineno-19-314"></a>
<a id="__codelineno-19-315" name="__codelineno-19-315" href="#__codelineno-19-315"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">is_sun6i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-316" name="__codelineno-19-316" href="#__codelineno-19-316"></a><span class="w">        </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">reg_offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sun6i_spi_reg_offsets</span><span class="p">;</span>
<a id="__codelineno-19-317" name="__codelineno-19-317" href="#__codelineno-19-317"></a><span class="w">        </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">spi_ctl_xch_bitmask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SUN6I_TCR_XCH</span><span class="p">;</span>
<a id="__codelineno-19-318" name="__codelineno-19-318" href="#__codelineno-19-318"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-319" name="__codelineno-19-319" href="#__codelineno-19-319"></a><span class="w">        </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">reg_offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sun4i_spi_reg_offsets</span><span class="p">;</span>
<a id="__codelineno-19-320" name="__codelineno-19-320" href="#__codelineno-19-320"></a><span class="w">        </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">spi_ctl_xch_bitmask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SUN4I_CTL_XCH</span><span class="p">;</span>
<a id="__codelineno-19-321" name="__codelineno-19-321" href="#__codelineno-19-321"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-322" name="__codelineno-19-322" href="#__codelineno-19-322"></a>
<a id="__codelineno-19-323" name="__codelineno-19-323" href="#__codelineno-19-323"></a><span class="w">    </span><span class="cm">/* TODO: initialize SPI with specified mode */</span>
<a id="__codelineno-19-324" name="__codelineno-19-324" href="#__codelineno-19-324"></a><span class="p">}</span>
<a id="__codelineno-19-325" name="__codelineno-19-325" href="#__codelineno-19-325"></a>
<a id="__codelineno-19-326" name="__codelineno-19-326" href="#__codelineno-19-326"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">spi0_deinit</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<a id="__codelineno-19-327" name="__codelineno-19-327" href="#__codelineno-19-327"></a><span class="p">{</span>
<a id="__codelineno-19-328" name="__codelineno-19-328" href="#__codelineno-19-328"></a><span class="w">    </span><span class="cm">/* New SoCs can disable pins, older could only set them as input */</span>
<a id="__codelineno-19-329" name="__codelineno-19-329" href="#__codelineno-19-329"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pin_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SUNXI_GPIO_INPUT</span><span class="p">;</span>
<a id="__codelineno-19-330" name="__codelineno-19-330" href="#__codelineno-19-330"></a>
<a id="__codelineno-19-331" name="__codelineno-19-331" href="#__codelineno-19-331"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_sun6i_gen_spi</span><span class="p">())</span>
<a id="__codelineno-19-332" name="__codelineno-19-332" href="#__codelineno-19-332"></a><span class="w">        </span><span class="n">pin_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SUNXI_GPIO_DISABLE</span><span class="p">;</span>
<a id="__codelineno-19-333" name="__codelineno-19-333" href="#__codelineno-19-333"></a>
<a id="__codelineno-19-334" name="__codelineno-19-334" href="#__codelineno-19-334"></a><span class="w">    </span><span class="n">spi0_disable_clock</span><span class="p">();</span>
<a id="__codelineno-19-335" name="__codelineno-19-335" href="#__codelineno-19-335"></a><span class="w">    </span><span class="n">spi0_pinmux_setup</span><span class="p">(</span><span class="n">pin_function</span><span class="p">);</span>
<a id="__codelineno-19-336" name="__codelineno-19-336" href="#__codelineno-19-336"></a><span class="p">}</span>
<a id="__codelineno-19-337" name="__codelineno-19-337" href="#__codelineno-19-337"></a>
<a id="__codelineno-19-338" name="__codelineno-19-338" href="#__codelineno-19-338"></a><span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">spi0_write_then_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span>
<a id="__codelineno-19-339" name="__codelineno-19-339" href="#__codelineno-19-339"></a><span class="w">                                    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">txbuf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">n_tx</span><span class="p">,</span>
<a id="__codelineno-19-340" name="__codelineno-19-340" href="#__codelineno-19-340"></a><span class="w">                                    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">rxbuf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">n_rx</span><span class="p">,</span>
<a id="__codelineno-19-341" name="__codelineno-19-341" href="#__codelineno-19-341"></a><span class="w">                                    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">delay</span><span class="p">)</span>
<a id="__codelineno-19-342" name="__codelineno-19-342" href="#__codelineno-19-342"></a><span class="p">{</span>
<a id="__codelineno-19-343" name="__codelineno-19-343" href="#__codelineno-19-343"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-19-344" name="__codelineno-19-344" href="#__codelineno-19-344"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">timeout</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-19-345" name="__codelineno-19-345" href="#__codelineno-19-345"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">real_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>
<a id="__codelineno-19-346" name="__codelineno-19-346" href="#__codelineno-19-346"></a><span class="w">    </span><span class="kt">ssize_t</span><span class="w">  </span><span class="n">len</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-347" name="__codelineno-19-347" href="#__codelineno-19-347"></a><span class="w">    </span><span class="kt">ssize_t</span><span class="w">  </span><span class="n">skip_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-348" name="__codelineno-19-348" href="#__codelineno-19-348"></a><span class="w">    </span><span class="n">u8</span><span class="w">       </span><span class="o">*</span><span class="n">txbuf8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">txbuf</span><span class="p">;</span>
<a id="__codelineno-19-349" name="__codelineno-19-349" href="#__codelineno-19-349"></a><span class="w">    </span><span class="n">u8</span><span class="w">       </span><span class="o">*</span><span class="n">rxbuf8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">rxbuf</span><span class="p">;</span>
<a id="__codelineno-19-350" name="__codelineno-19-350" href="#__codelineno-19-350"></a>
<a id="__codelineno-19-351" name="__codelineno-19-351" href="#__codelineno-19-351"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_bc_reg</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">bc_reg</span><span class="p">);</span>
<a id="__codelineno-19-352" name="__codelineno-19-352" href="#__codelineno-19-352"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_tc_reg</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">tc_reg</span><span class="p">);</span>
<a id="__codelineno-19-353" name="__codelineno-19-353" href="#__codelineno-19-353"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_bcc_reg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">bcc_reg</span><span class="p">);</span>
<a id="__codelineno-19-354" name="__codelineno-19-354" href="#__codelineno-19-354"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_rx_reg</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">rx_reg</span><span class="p">);</span>
<a id="__codelineno-19-355" name="__codelineno-19-355" href="#__codelineno-19-355"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_tx_reg</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">tx_reg</span><span class="p">);</span>
<a id="__codelineno-19-356" name="__codelineno-19-356" href="#__codelineno-19-356"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_ctl_reg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">ctl_reg</span><span class="p">);</span>
<a id="__codelineno-19-357" name="__codelineno-19-357" href="#__codelineno-19-357"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_fifo_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">fifo_reg</span><span class="p">);</span>
<a id="__codelineno-19-358" name="__codelineno-19-358" href="#__codelineno-19-358"></a>
<a id="__codelineno-19-359" name="__codelineno-19-359" href="#__codelineno-19-359"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-19-360" name="__codelineno-19-360" href="#__codelineno-19-360"></a><span class="w">        </span><span class="n">real_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delay</span><span class="p">;</span>
<a id="__codelineno-19-361" name="__codelineno-19-361" href="#__codelineno-19-361"></a>
<a id="__codelineno-19-362" name="__codelineno-19-362" href="#__codelineno-19-362"></a><span class="w">    </span><span class="cm">/* Burst counter (total bytes) */</span>
<a id="__codelineno-19-363" name="__codelineno-19-363" href="#__codelineno-19-363"></a><span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">n_tx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_rx</span><span class="p">,</span><span class="w"> </span><span class="n">spi_bc_reg</span><span class="p">);</span>
<a id="__codelineno-19-364" name="__codelineno-19-364" href="#__codelineno-19-364"></a><span class="w">    </span><span class="cm">/* Transfer counter (bytes to send) */</span>
<a id="__codelineno-19-365" name="__codelineno-19-365" href="#__codelineno-19-365"></a><span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">n_tx</span><span class="p">,</span><span class="w"> </span><span class="n">spi_tc_reg</span><span class="p">);</span>
<a id="__codelineno-19-366" name="__codelineno-19-366" href="#__codelineno-19-366"></a>
<a id="__codelineno-19-367" name="__codelineno-19-367" href="#__codelineno-19-367"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">is_sun6i</span><span class="p">)</span>
<a id="__codelineno-19-368" name="__codelineno-19-368" href="#__codelineno-19-368"></a><span class="w">        </span><span class="n">writel</span><span class="p">(</span><span class="n">n_tx</span><span class="p">,</span><span class="w"> </span><span class="n">spi_bcc_reg</span><span class="p">);</span>
<a id="__codelineno-19-369" name="__codelineno-19-369" href="#__codelineno-19-369"></a>
<a id="__codelineno-19-370" name="__codelineno-19-370" href="#__codelineno-19-370"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_tx</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-19-371" name="__codelineno-19-371" href="#__codelineno-19-371"></a><span class="w">        </span><span class="n">writeb</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">txbuf8</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">spi_tx_reg</span><span class="p">);</span>
<a id="__codelineno-19-372" name="__codelineno-19-372" href="#__codelineno-19-372"></a>
<a id="__codelineno-19-373" name="__codelineno-19-373" href="#__codelineno-19-373"></a><span class="w">    </span><span class="cm">/* Start the data transfer */</span>
<a id="__codelineno-19-374" name="__codelineno-19-374" href="#__codelineno-19-374"></a><span class="w">    </span><span class="n">setbits_le32</span><span class="p">(</span><span class="n">spi_ctl_reg</span><span class="p">,</span><span class="w"> </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">spi_ctl_xch_bitmask</span><span class="p">);</span>
<a id="__codelineno-19-375" name="__codelineno-19-375" href="#__codelineno-19-375"></a><span class="w">    </span><span class="n">udelay</span><span class="p">(</span><span class="n">real_delay</span><span class="p">);</span>
<a id="__codelineno-19-376" name="__codelineno-19-376" href="#__codelineno-19-376"></a>
<a id="__codelineno-19-377" name="__codelineno-19-377" href="#__codelineno-19-377"></a><span class="w">    </span><span class="cm">/* Wait until everything is received in the RX FIFO */</span>
<a id="__codelineno-19-378" name="__codelineno-19-378" href="#__codelineno-19-378"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-379" name="__codelineno-19-379" href="#__codelineno-19-379"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">spi_fifo_reg</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">n_rx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-19-380" name="__codelineno-19-380" href="#__codelineno-19-380"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-19-381" name="__codelineno-19-381" href="#__codelineno-19-381"></a>
<a id="__codelineno-19-382" name="__codelineno-19-382" href="#__codelineno-19-382"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-19-383" name="__codelineno-19-383" href="#__codelineno-19-383"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-19-384" name="__codelineno-19-384" href="#__codelineno-19-384"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-385" name="__codelineno-19-385" href="#__codelineno-19-385"></a>
<a id="__codelineno-19-386" name="__codelineno-19-386" href="#__codelineno-19-386"></a><span class="w">    </span><span class="cm">/* Skip bytes */</span>
<a id="__codelineno-19-387" name="__codelineno-19-387" href="#__codelineno-19-387"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">skip_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_tx</span><span class="p">;</span><span class="w"> </span><span class="n">skip_bytes</span><span class="o">--</span><span class="p">;)</span>
<a id="__codelineno-19-388" name="__codelineno-19-388" href="#__codelineno-19-388"></a><span class="w">        </span><span class="n">readb</span><span class="p">(</span><span class="n">spi_rx_reg</span><span class="p">);</span>
<a id="__codelineno-19-389" name="__codelineno-19-389" href="#__codelineno-19-389"></a>
<a id="__codelineno-19-390" name="__codelineno-19-390" href="#__codelineno-19-390"></a><span class="w">    </span><span class="cm">/* if only need to be write */</span>
<a id="__codelineno-19-391" name="__codelineno-19-391" href="#__codelineno-19-391"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n_rx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-19-392" name="__codelineno-19-392" href="#__codelineno-19-392"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-393" name="__codelineno-19-393" href="#__codelineno-19-393"></a>
<a id="__codelineno-19-394" name="__codelineno-19-394" href="#__codelineno-19-394"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">n_rx</span><span class="o">--</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-395" name="__codelineno-19-395" href="#__codelineno-19-395"></a><span class="w">        </span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-19-396" name="__codelineno-19-396" href="#__codelineno-19-396"></a><span class="w">        </span><span class="o">*</span><span class="n">rxbuf8</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readb</span><span class="p">(</span><span class="n">spi_rx_reg</span><span class="p">);</span>
<a id="__codelineno-19-397" name="__codelineno-19-397" href="#__codelineno-19-397"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-398" name="__codelineno-19-398" href="#__codelineno-19-398"></a>
<a id="__codelineno-19-399" name="__codelineno-19-399" href="#__codelineno-19-399"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_rx</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-19-400" name="__codelineno-19-400" href="#__codelineno-19-400"></a><span class="p">}</span>
<a id="__codelineno-19-401" name="__codelineno-19-401" href="#__codelineno-19-401"></a>
<a id="__codelineno-19-402" name="__codelineno-19-402" href="#__codelineno-19-402"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="nf">spi_nand_read_id</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<a id="__codelineno-19-403" name="__codelineno-19-403" href="#__codelineno-19-403"></a><span class="p">{</span>
<a id="__codelineno-19-404" name="__codelineno-19-404" href="#__codelineno-19-404"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">cmds</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x9f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">};</span>
<a id="__codelineno-19-405" name="__codelineno-19-405" href="#__codelineno-19-405"></a><span class="w">    </span><span class="n">u32</span><span class="w">     </span><span class="n">result</span><span class="p">;</span>
<a id="__codelineno-19-406" name="__codelineno-19-406" href="#__codelineno-19-406"></a><span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="__codelineno-19-407" name="__codelineno-19-407" href="#__codelineno-19-407"></a>
<a id="__codelineno-19-408" name="__codelineno-19-408" href="#__codelineno-19-408"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi0_write_then_read</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">cmds</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmds</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-19-409" name="__codelineno-19-409" href="#__codelineno-19-409"></a><span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="__codelineno-19-410" name="__codelineno-19-410" href="#__codelineno-19-410"></a>
<a id="__codelineno-19-411" name="__codelineno-19-411" href="#__codelineno-19-411"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<a id="__codelineno-19-412" name="__codelineno-19-412" href="#__codelineno-19-412"></a><span class="p">}</span>
<a id="__codelineno-19-413" name="__codelineno-19-413" href="#__codelineno-19-413"></a>
<a id="__codelineno-19-414" name="__codelineno-19-414" href="#__codelineno-19-414"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">u8</span>
<a id="__codelineno-19-415" name="__codelineno-19-415" href="#__codelineno-19-415"></a><span class="nf">spi_nand_read_status_reg</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">reg_addr</span><span class="p">)</span>
<a id="__codelineno-19-416" name="__codelineno-19-416" href="#__codelineno-19-416"></a><span class="p">{</span>
<a id="__codelineno-19-417" name="__codelineno-19-417" href="#__codelineno-19-417"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<a id="__codelineno-19-418" name="__codelineno-19-418" href="#__codelineno-19-418"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">txbuf</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">,</span><span class="w"> </span><span class="n">reg_addr</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-19-419" name="__codelineno-19-419" href="#__codelineno-19-419"></a><span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="__codelineno-19-420" name="__codelineno-19-420" href="#__codelineno-19-420"></a>
<a id="__codelineno-19-421" name="__codelineno-19-421" href="#__codelineno-19-421"></a>
<a id="__codelineno-19-422" name="__codelineno-19-422" href="#__codelineno-19-422"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">spi0_write_then_read</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">txbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">txbuf</span><span class="p">),</span>
<a id="__codelineno-19-423" name="__codelineno-19-423" href="#__codelineno-19-423"></a><span class="w">                                   </span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-19-424" name="__codelineno-19-424" href="#__codelineno-19-424"></a>
<a id="__codelineno-19-425" name="__codelineno-19-425" href="#__codelineno-19-425"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<a id="__codelineno-19-426" name="__codelineno-19-426" href="#__codelineno-19-426"></a><span class="p">}</span>
<a id="__codelineno-19-427" name="__codelineno-19-427" href="#__codelineno-19-427"></a>
<a id="__codelineno-19-428" name="__codelineno-19-428" href="#__codelineno-19-428"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">ssize_t</span>
<a id="__codelineno-19-429" name="__codelineno-19-429" href="#__codelineno-19-429"></a><span class="nf">spi_nand_write_status_reg</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">reg_addr</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">reg_val</span><span class="p">)</span>
<a id="__codelineno-19-430" name="__codelineno-19-430" href="#__codelineno-19-430"></a><span class="p">{</span>
<a id="__codelineno-19-431" name="__codelineno-19-431" href="#__codelineno-19-431"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">txbuf</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">,</span><span class="w"> </span><span class="n">reg_addr</span><span class="p">,</span><span class="w"> </span><span class="n">reg_val</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-19-432" name="__codelineno-19-432" href="#__codelineno-19-432"></a>
<a id="__codelineno-19-433" name="__codelineno-19-433" href="#__codelineno-19-433"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">spi0_write_then_read</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">txbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">txbuf</span><span class="p">),</span>
<a id="__codelineno-19-434" name="__codelineno-19-434" href="#__codelineno-19-434"></a><span class="w">                                </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-19-435" name="__codelineno-19-435" href="#__codelineno-19-435"></a><span class="p">}</span>
<a id="__codelineno-19-436" name="__codelineno-19-436" href="#__codelineno-19-436"></a>
<a id="__codelineno-19-437" name="__codelineno-19-437" href="#__codelineno-19-437"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">spi_nand_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<a id="__codelineno-19-438" name="__codelineno-19-438" href="#__codelineno-19-438"></a><span class="p">{</span>
<a id="__codelineno-19-439" name="__codelineno-19-439" href="#__codelineno-19-439"></a><span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;loading payload from SPI NAND ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-19-440" name="__codelineno-19-440" href="#__codelineno-19-440"></a>
<a id="__codelineno-19-441" name="__codelineno-19-441" href="#__codelineno-19-441"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi_nand_read_id</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
<a id="__codelineno-19-442" name="__codelineno-19-442" href="#__codelineno-19-442"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;detected JEDEC ID : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<a id="__codelineno-19-443" name="__codelineno-19-443" href="#__codelineno-19-443"></a>
<a id="__codelineno-19-444" name="__codelineno-19-444" href="#__codelineno-19-444"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x00efaa21</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-445" name="__codelineno-19-445" href="#__codelineno-19-445"></a><span class="w">        </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">nand_dev</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;w25n01g&quot;</span><span class="p">;</span>
<a id="__codelineno-19-446" name="__codelineno-19-446" href="#__codelineno-19-446"></a><span class="w">        </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">nand_dev</span><span class="p">.</span><span class="n">page_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">11</span><span class="p">);</span><span class="w">    </span><span class="cm">/* 2048 */</span>
<a id="__codelineno-19-447" name="__codelineno-19-447" href="#__codelineno-19-447"></a><span class="w">        </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">nand_dev</span><span class="p">.</span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">17</span><span class="p">);</span><span class="w">   </span><span class="cm">/* 128KB */</span>
<a id="__codelineno-19-448" name="__codelineno-19-448" href="#__codelineno-19-448"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-449" name="__codelineno-19-449" href="#__codelineno-19-449"></a><span class="w">        </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;###### NAND Device Not supported yet! #####</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-19-450" name="__codelineno-19-450" href="#__codelineno-19-450"></a><span class="w">        </span><span class="n">hang</span><span class="p">();</span>
<a id="__codelineno-19-451" name="__codelineno-19-451" href="#__codelineno-19-451"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-452" name="__codelineno-19-452" href="#__codelineno-19-452"></a>
<a id="__codelineno-19-453" name="__codelineno-19-453" href="#__codelineno-19-453"></a><span class="w">    </span><span class="cm">/* in the beginning, there&#39;s no page was loaded into cache */</span>
<a id="__codelineno-19-454" name="__codelineno-19-454" href="#__codelineno-19-454"></a><span class="w">    </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">nand_dev</span><span class="p">.</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-19-455" name="__codelineno-19-455" href="#__codelineno-19-455"></a>
<a id="__codelineno-19-456" name="__codelineno-19-456" href="#__codelineno-19-456"></a><span class="w">    </span><span class="cm">/* set spinand into continuous read mode */</span>
<a id="__codelineno-19-457" name="__codelineno-19-457" href="#__codelineno-19-457"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">stat2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi_nand_read_status_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0</span><span class="p">);</span>
<a id="__codelineno-19-458" name="__codelineno-19-458" href="#__codelineno-19-458"></a>
<a id="__codelineno-19-459" name="__codelineno-19-459" href="#__codelineno-19-459"></a><span class="w">    </span><span class="n">stat2</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w">  </span><span class="cm">/* bit BUF = 1, ECC-E = 1 */</span>
<a id="__codelineno-19-460" name="__codelineno-19-460" href="#__codelineno-19-460"></a><span class="w">    </span><span class="n">spi_nand_write_status_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="mh">0xb0</span><span class="p">,</span><span class="w"> </span><span class="n">stat2</span><span class="p">);</span>
<a id="__codelineno-19-461" name="__codelineno-19-461" href="#__codelineno-19-461"></a>
<a id="__codelineno-19-462" name="__codelineno-19-462" href="#__codelineno-19-462"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-463" name="__codelineno-19-463" href="#__codelineno-19-463"></a><span class="p">}</span>
<a id="__codelineno-19-464" name="__codelineno-19-464" href="#__codelineno-19-464"></a>
<a id="__codelineno-19-465" name="__codelineno-19-465" href="#__codelineno-19-465"></a><span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span>
<a id="__codelineno-19-466" name="__codelineno-19-466" href="#__codelineno-19-466"></a><span class="nf">spi_nand_load_page_op</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">page</span><span class="p">)</span>
<a id="__codelineno-19-467" name="__codelineno-19-467" href="#__codelineno-19-467"></a><span class="p">{</span>
<a id="__codelineno-19-468" name="__codelineno-19-468" href="#__codelineno-19-468"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">txbuf</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-469" name="__codelineno-19-469" href="#__codelineno-19-469"></a><span class="w">        </span><span class="n">SPI_NAND_RD_PAGE_DATA</span><span class="p">,</span>
<a id="__codelineno-19-470" name="__codelineno-19-470" href="#__codelineno-19-470"></a><span class="w">        </span><span class="mh">0x00</span><span class="p">,</span><span class="w">   </span><span class="cm">/* dummy clock */</span>
<a id="__codelineno-19-471" name="__codelineno-19-471" href="#__codelineno-19-471"></a><span class="w">        </span><span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">page</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span>
<a id="__codelineno-19-472" name="__codelineno-19-472" href="#__codelineno-19-472"></a><span class="w">        </span><span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">page</span><span class="p">),</span>
<a id="__codelineno-19-473" name="__codelineno-19-473" href="#__codelineno-19-473"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-19-474" name="__codelineno-19-474" href="#__codelineno-19-474"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">spi0_write_then_read</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">txbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">txbuf</span><span class="p">),</span>
<a id="__codelineno-19-475" name="__codelineno-19-475" href="#__codelineno-19-475"></a><span class="w">                                </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">);</span>
<a id="__codelineno-19-476" name="__codelineno-19-476" href="#__codelineno-19-476"></a><span class="p">}</span>
<a id="__codelineno-19-477" name="__codelineno-19-477" href="#__codelineno-19-477"></a>
<a id="__codelineno-19-478" name="__codelineno-19-478" href="#__codelineno-19-478"></a><span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span>
<a id="__codelineno-19-479" name="__codelineno-19-479" href="#__codelineno-19-479"></a><span class="nf">spi_nand_read_from_cache_op</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">column</span><span class="p">,</span>
<a id="__codelineno-19-480" name="__codelineno-19-480" href="#__codelineno-19-480"></a><span class="w">                            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">rxbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-19-481" name="__codelineno-19-481" href="#__codelineno-19-481"></a><span class="p">{</span>
<a id="__codelineno-19-482" name="__codelineno-19-482" href="#__codelineno-19-482"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">txbuf</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-483" name="__codelineno-19-483" href="#__codelineno-19-483"></a><span class="w">        </span><span class="n">SPI_NAND_RD_DATA</span><span class="p">,</span>
<a id="__codelineno-19-484" name="__codelineno-19-484" href="#__codelineno-19-484"></a><span class="w">        </span><span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">column</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span>
<a id="__codelineno-19-485" name="__codelineno-19-485" href="#__codelineno-19-485"></a><span class="w">        </span><span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">column</span><span class="p">),</span>
<a id="__codelineno-19-486" name="__codelineno-19-486" href="#__codelineno-19-486"></a><span class="w">        </span><span class="mh">0x00</span><span class="p">,</span><span class="w">   </span><span class="cm">/* dummy clock */</span>
<a id="__codelineno-19-487" name="__codelineno-19-487" href="#__codelineno-19-487"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-19-488" name="__codelineno-19-488" href="#__codelineno-19-488"></a>
<a id="__codelineno-19-489" name="__codelineno-19-489" href="#__codelineno-19-489"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">spi0_write_then_read</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">txbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">txbuf</span><span class="p">),</span><span class="w"> </span><span class="n">rxbuf</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-19-490" name="__codelineno-19-490" href="#__codelineno-19-490"></a><span class="p">}</span>
<a id="__codelineno-19-491" name="__codelineno-19-491" href="#__codelineno-19-491"></a>
<a id="__codelineno-19-492" name="__codelineno-19-492" href="#__codelineno-19-492"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">sunxi_spi0_nand_read_data</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-19-493" name="__codelineno-19-493" href="#__codelineno-19-493"></a><span class="p">{</span>
<a id="__codelineno-19-494" name="__codelineno-19-494" href="#__codelineno-19-494"></a><span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="__codelineno-19-495" name="__codelineno-19-495" href="#__codelineno-19-495"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span>
<a id="__codelineno-19-496" name="__codelineno-19-496" href="#__codelineno-19-496"></a>
<a id="__codelineno-19-497" name="__codelineno-19-497" href="#__codelineno-19-497"></a><span class="w">    </span><span class="cm">/* load page to data buffer */</span>
<a id="__codelineno-19-498" name="__codelineno-19-498" href="#__codelineno-19-498"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">nand_dev</span><span class="p">.</span><span class="n">page</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-499" name="__codelineno-19-499" href="#__codelineno-19-499"></a><span class="w">        </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">nand_dev</span><span class="p">.</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">page</span><span class="p">;</span>
<a id="__codelineno-19-500" name="__codelineno-19-500" href="#__codelineno-19-500"></a>
<a id="__codelineno-19-501" name="__codelineno-19-501" href="#__codelineno-19-501"></a><span class="w">        </span><span class="n">spi_nand_load_page_op</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">page</span><span class="p">);</span>
<a id="__codelineno-19-502" name="__codelineno-19-502" href="#__codelineno-19-502"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-503" name="__codelineno-19-503" href="#__codelineno-19-503"></a>
<a id="__codelineno-19-504" name="__codelineno-19-504" href="#__codelineno-19-504"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-19-505" name="__codelineno-19-505" href="#__codelineno-19-505"></a><span class="cm">     * the check the addr, make sure it&#39;s in data buffer</span>
<a id="__codelineno-19-506" name="__codelineno-19-506" href="#__codelineno-19-506"></a><span class="cm">     * usually be used to load the endless of the page</span>
<a id="__codelineno-19-507" name="__codelineno-19-507" href="#__codelineno-19-507"></a><span class="cm">     */</span>
<a id="__codelineno-19-508" name="__codelineno-19-508" href="#__codelineno-19-508"></a><span class="w">    </span><span class="n">addr</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="mh">0x7FF</span><span class="p">;</span>
<a id="__codelineno-19-509" name="__codelineno-19-509" href="#__codelineno-19-509"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">nand_dev</span><span class="p">.</span><span class="n">page_size</span><span class="p">)</span>
<a id="__codelineno-19-510" name="__codelineno-19-510" href="#__codelineno-19-510"></a><span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">nand_dev</span><span class="p">.</span><span class="n">page_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<a id="__codelineno-19-511" name="__codelineno-19-511" href="#__codelineno-19-511"></a>
<a id="__codelineno-19-512" name="__codelineno-19-512" href="#__codelineno-19-512"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spi_nand_read_from_cache_op</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-19-513" name="__codelineno-19-513" href="#__codelineno-19-513"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<a id="__codelineno-19-514" name="__codelineno-19-514" href="#__codelineno-19-514"></a><span class="p">}</span>
<a id="__codelineno-19-515" name="__codelineno-19-515" href="#__codelineno-19-515"></a>
<a id="__codelineno-19-516" name="__codelineno-19-516" href="#__codelineno-19-516"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">spi0_nand_read_data</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-19-517" name="__codelineno-19-517" href="#__codelineno-19-517"></a><span class="p">{</span>
<a id="__codelineno-19-518" name="__codelineno-19-518" href="#__codelineno-19-518"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">buf8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span>
<a id="__codelineno-19-519" name="__codelineno-19-519" href="#__codelineno-19-519"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">chunk_len</span><span class="p">;</span>
<a id="__codelineno-19-520" name="__codelineno-19-520" href="#__codelineno-19-520"></a>
<a id="__codelineno-19-521" name="__codelineno-19-521" href="#__codelineno-19-521"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">loop_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-522" name="__codelineno-19-522" href="#__codelineno-19-522"></a>
<a id="__codelineno-19-523" name="__codelineno-19-523" href="#__codelineno-19-523"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-524" name="__codelineno-19-524" href="#__codelineno-19-524"></a><span class="w">        </span><span class="n">chunk_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-19-525" name="__codelineno-19-525" href="#__codelineno-19-525"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chunk_len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">SPI_READ_MAX_SIZE</span><span class="p">)</span>
<a id="__codelineno-19-526" name="__codelineno-19-526" href="#__codelineno-19-526"></a><span class="w">            </span><span class="n">chunk_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SPI_READ_MAX_SIZE</span><span class="p">;</span>
<a id="__codelineno-19-527" name="__codelineno-19-527" href="#__codelineno-19-527"></a>
<a id="__codelineno-19-528" name="__codelineno-19-528" href="#__codelineno-19-528"></a><span class="w">        </span><span class="n">sunxi_spi0_nand_read_data</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">buf8</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">chunk_len</span><span class="p">);</span>
<a id="__codelineno-19-529" name="__codelineno-19-529" href="#__codelineno-19-529"></a><span class="w">        </span><span class="n">len</span><span class="w">  </span><span class="o">-=</span><span class="w"> </span><span class="n">chunk_len</span><span class="p">;</span>
<a id="__codelineno-19-530" name="__codelineno-19-530" href="#__codelineno-19-530"></a><span class="w">        </span><span class="n">buf8</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">chunk_len</span><span class="p">;</span>
<a id="__codelineno-19-531" name="__codelineno-19-531" href="#__codelineno-19-531"></a><span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">chunk_len</span><span class="p">;</span>
<a id="__codelineno-19-532" name="__codelineno-19-532" href="#__codelineno-19-532"></a>
<a id="__codelineno-19-533" name="__codelineno-19-533" href="#__codelineno-19-533"></a><span class="w">        </span><span class="n">loop_count</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-19-534" name="__codelineno-19-534" href="#__codelineno-19-534"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-535" name="__codelineno-19-535" href="#__codelineno-19-535"></a>
<a id="__codelineno-19-536" name="__codelineno-19-536" href="#__codelineno-19-536"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-537" name="__codelineno-19-537" href="#__codelineno-19-537"></a><span class="p">}</span>
<a id="__codelineno-19-538" name="__codelineno-19-538" href="#__codelineno-19-538"></a>
<a id="__codelineno-19-539" name="__codelineno-19-539" href="#__codelineno-19-539"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">spl_spi_nand_load_image</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">spl_image_info</span><span class="w"> </span><span class="o">*</span><span class="n">spl_image</span><span class="p">,</span>
<a id="__codelineno-19-540" name="__codelineno-19-540" href="#__codelineno-19-540"></a><span class="w">                              </span><span class="k">struct</span><span class="w"> </span><span class="nc">spl_boot_device</span><span class="w"> </span><span class="o">*</span><span class="n">bootdev</span><span class="p">)</span>
<a id="__codelineno-19-541" name="__codelineno-19-541" href="#__codelineno-19-541"></a><span class="p">{</span>
<a id="__codelineno-19-542" name="__codelineno-19-542" href="#__codelineno-19-542"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-19-543" name="__codelineno-19-543" href="#__codelineno-19-543"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">legacy_img_hdr</span><span class="w"> </span><span class="o">*</span><span class="n">header</span><span class="p">;</span>
<a id="__codelineno-19-544" name="__codelineno-19-544" href="#__codelineno-19-544"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">load_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sunxi_get_spl_size</span><span class="p">();</span>
<a id="__codelineno-19-545" name="__codelineno-19-545" href="#__codelineno-19-545"></a>
<a id="__codelineno-19-546" name="__codelineno-19-546" href="#__codelineno-19-546"></a><span class="w">    </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">legacy_img_hdr</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">CONFIG_TEXT_BASE</span><span class="p">;</span>
<a id="__codelineno-19-547" name="__codelineno-19-547" href="#__codelineno-19-547"></a><span class="w">    </span><span class="n">load_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max_t</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="n">load_offset</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIG_SYS_SPI_U_BOOT_OFFS</span><span class="p">);</span>
<a id="__codelineno-19-548" name="__codelineno-19-548" href="#__codelineno-19-548"></a>
<a id="__codelineno-19-549" name="__codelineno-19-549" href="#__codelineno-19-549"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="p">));</span>
<a id="__codelineno-19-550" name="__codelineno-19-550" href="#__codelineno-19-550"></a>
<a id="__codelineno-19-551" name="__codelineno-19-551" href="#__codelineno-19-551"></a><span class="w">    </span><span class="n">spi0_init</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
<a id="__codelineno-19-552" name="__codelineno-19-552" href="#__codelineno-19-552"></a><span class="w">    </span><span class="n">spi_nand_init</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
<a id="__codelineno-19-553" name="__codelineno-19-553" href="#__codelineno-19-553"></a>
<a id="__codelineno-19-554" name="__codelineno-19-554" href="#__codelineno-19-554"></a><span class="w">    </span><span class="n">spi0_nand_read_data</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">load_offset</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">);</span>
<a id="__codelineno-19-555" name="__codelineno-19-555" href="#__codelineno-19-555"></a>
<a id="__codelineno-19-556" name="__codelineno-19-556" href="#__codelineno-19-556"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_SPL_LOAD_FIT</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-19-557" name="__codelineno-19-557" href="#__codelineno-19-557"></a><span class="w">        </span><span class="n">image_get_magic</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FDT_MAGIC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-558" name="__codelineno-19-558" href="#__codelineno-19-558"></a><span class="w">        </span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Not supported FIT image yet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-19-559" name="__codelineno-19-559" href="#__codelineno-19-559"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-560" name="__codelineno-19-560" href="#__codelineno-19-560"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spl_parse_image_header</span><span class="p">(</span><span class="n">spl_image</span><span class="p">,</span><span class="w"> </span><span class="n">bootdev</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="p">);</span>
<a id="__codelineno-19-561" name="__codelineno-19-561" href="#__codelineno-19-561"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
<a id="__codelineno-19-562" name="__codelineno-19-562" href="#__codelineno-19-562"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-19-563" name="__codelineno-19-563" href="#__codelineno-19-563"></a>
<a id="__codelineno-19-564" name="__codelineno-19-564" href="#__codelineno-19-564"></a><span class="w">        </span><span class="n">spi0_nand_read_data</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">spl_image</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">,</span>
<a id="__codelineno-19-565" name="__codelineno-19-565" href="#__codelineno-19-565"></a><span class="w">                            </span><span class="n">load_offset</span><span class="p">,</span><span class="w"> </span><span class="n">spl_image</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-19-566" name="__codelineno-19-566" href="#__codelineno-19-566"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-567" name="__codelineno-19-567" href="#__codelineno-19-567"></a>
<a id="__codelineno-19-568" name="__codelineno-19-568" href="#__codelineno-19-568"></a><span class="w">    </span><span class="n">spi0_deinit</span><span class="p">(</span><span class="n">spi</span><span class="p">);</span>
<a id="__codelineno-19-569" name="__codelineno-19-569" href="#__codelineno-19-569"></a>
<a id="__codelineno-19-570" name="__codelineno-19-570" href="#__codelineno-19-570"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-19-571" name="__codelineno-19-571" href="#__codelineno-19-571"></a><span class="p">}</span>
<a id="__codelineno-19-572" name="__codelineno-19-572" href="#__codelineno-19-572"></a>
<a id="__codelineno-19-573" name="__codelineno-19-573" href="#__codelineno-19-573"></a><span class="cm">/* Use priorty 0 to override the default if it happens to be linked in */</span>
<a id="__codelineno-19-574" name="__codelineno-19-574" href="#__codelineno-19-574"></a><span class="n">SPL_LOAD_IMAGE_METHOD</span><span class="p">(</span><span class="s">&quot;sunxi SPI-NAND&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">BOOT_DEVICE_NAND</span><span class="p">,</span><span class="w"> </span><span class="n">spl_spi_nand_load_image</span><span class="p">);</span>
</code></pre></div>
经过该宏，我们的加载函数最终会被调用，主要责任就是将uboot加载到 <code>entry_point</code>处的地址</p>
<p>有关读器件的细节，以及平台SPI的通信，我想应该没太多人感兴趣，也不是本文重点，所以放到文章末尾<code>更多</code>章节中吧</p>
<h2 id="_6">优化思路</h2>
<p>所以这个启动流程还是有很多优化空间的，比如如下几个部分</p>
<ol>
<li>SPI的时钟。我只给了SPI 3MHz的速率，跟BootROM中的一致，所以你可以试着提高下这个速度，也许会读的更快</li>
<li>uboot 设备树里 spi节点设置的速度，也会影响读flash的速度</li>
<li>程序里可能有些没必要的环节，可以优化掉</li>
<li>如果空间足够大，就不要压缩固件了，解压也会消耗掉一部分时间，但不会太多</li>
<li>暂时没想到，以后再说吧</li>
</ol>
<h2 id="_7">基准测试</h2>
<h3 id="spi">SPI速率</h3>
<p>SPI的父时钟来自于200MHz的AHB总线，可通过调整分频系数来控制SPI控制器的主时钟
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>
</code></pre></div></p>
<p>我们使用如下方法统计耗时
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="cp">#define TIMER_CLOCK     (24 * 1000 * 1000)</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="cp">#define TICKS_PER_HZ        (TIMER_CLOCK / CONFIG_SYS_HZ)</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="cp">#define TICKS_TO_HZ(x)      ((x) / TICKS_PER_HZ)</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_timer</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">te</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_timer</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cost : %ld (tick), %ld (ms)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">te</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts</span><span class="p">,</span><span class="w"> </span><span class="n">TICKS_TO_HZ</span><span class="p">((</span><span class="n">te</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">));</span>
</code></pre></div>
| 分频 | 速率 | 耗时 |
| --- | --- | --- |
| DIV_64 | 3MHz  | cost : 1918 (tick), 79 (ms) |
| DIV_32 | 6MHz  | cost : 1918 (tick), 79 (ms) |
| DIV_4 | 50MHz  | cost : 1918 (tick), 79 (ms) |</p>
<p>结论，SPI速率对spl加载uboot无太大影响，微乎其微。</p>
<h2 id="_8">更多</h2>
<blockquote>
<h4 id="w25n01g">W25N01G的读操作流程</h4>
</blockquote>
<p>W25N01G normal 读模式下，需要先将page加载到器件内部data buffer，然后再发送读指令，从data buffer中获取数据。
然后加载下一页，反复。还有一种连续读方式，可以一次性读出整个page，但是这个片子的SPI RX FIFO没有那么大。
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">spi0_write_then_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">                                    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">txbuf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">n_tx</span><span class="p">,</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">                                    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">rxbuf</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="w"> </span><span class="n">n_rx</span><span class="p">,</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">                                    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">delay</span><span class="p">)</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="p">{</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">timeout</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">real_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">    </span><span class="kt">ssize_t</span><span class="w">  </span><span class="n">len</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">    </span><span class="kt">ssize_t</span><span class="w">  </span><span class="n">skip_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">    </span><span class="n">u8</span><span class="w">       </span><span class="o">*</span><span class="n">txbuf8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">txbuf</span><span class="p">;</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">    </span><span class="n">u8</span><span class="w">       </span><span class="o">*</span><span class="n">rxbuf8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">rxbuf</span><span class="p">;</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_bc_reg</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">bc_reg</span><span class="p">);</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_tc_reg</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">tc_reg</span><span class="p">);</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_bcc_reg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">bcc_reg</span><span class="p">);</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_rx_reg</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">rx_reg</span><span class="p">);</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_tx_reg</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">tx_reg</span><span class="p">);</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_ctl_reg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">ctl_reg</span><span class="p">);</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">    </span><span class="n">ulong</span><span class="w"> </span><span class="n">spi_fifo_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_sunxi_spi_reg</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">fifo_reg</span><span class="p">);</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">        </span><span class="n">real_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delay</span><span class="p">;</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">    </span><span class="cm">/* Burst counter (total bytes) */</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">n_tx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_rx</span><span class="p">,</span><span class="w"> </span><span class="n">spi_bc_reg</span><span class="p">);</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">    </span><span class="cm">/* Transfer counter (bytes to send) */</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">n_tx</span><span class="p">,</span><span class="w"> </span><span class="n">spi_tc_reg</span><span class="p">);</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">is_sun6i</span><span class="p">)</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="w">        </span><span class="n">writel</span><span class="p">(</span><span class="n">n_tx</span><span class="p">,</span><span class="w"> </span><span class="n">spi_bcc_reg</span><span class="p">);</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_tx</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="w">        </span><span class="n">writeb</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">txbuf8</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">spi_tx_reg</span><span class="p">);</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="w">    </span><span class="cm">/* Start the data transfer */</span>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="w">    </span><span class="n">setbits_le32</span><span class="p">(</span><span class="n">spi_ctl_reg</span><span class="p">,</span><span class="w"> </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">spi_ctl_xch_bitmask</span><span class="p">);</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="w">    </span><span class="n">udelay</span><span class="p">(</span><span class="n">real_delay</span><span class="p">);</span>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="w">    </span><span class="cm">/* Wait until everything is received in the RX FIFO */</span>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">spi_fifo_reg</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">n_rx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a>
<a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a><span class="w">    </span><span class="cm">/* Skip bytes */</span>
<a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">skip_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_tx</span><span class="p">;</span><span class="w"> </span><span class="n">skip_bytes</span><span class="o">--</span><span class="p">;)</span>
<a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a><span class="w">        </span><span class="n">readb</span><span class="p">(</span><span class="n">spi_rx_reg</span><span class="p">);</span>
<a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a>
<a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a><span class="w">    </span><span class="cm">/* if only need to be write */</span>
<a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n_rx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a>
<a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">n_rx</span><span class="o">--</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a><span class="w">        </span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a><span class="w">        </span><span class="o">*</span><span class="n">rxbuf8</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readb</span><span class="p">(</span><span class="n">spi_rx_reg</span><span class="p">);</span>
<a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a>
<a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_rx</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-22-63" name="__codelineno-22-63" href="#__codelineno-22-63"></a><span class="p">}</span>
<a id="__codelineno-22-64" name="__codelineno-22-64" href="#__codelineno-22-64"></a>
<a id="__codelineno-22-65" name="__codelineno-22-65" href="#__codelineno-22-65"></a><span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span>
<a id="__codelineno-22-66" name="__codelineno-22-66" href="#__codelineno-22-66"></a><span class="nf">spi_nand_load_page_op</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">page</span><span class="p">)</span>
<a id="__codelineno-22-67" name="__codelineno-22-67" href="#__codelineno-22-67"></a><span class="p">{</span>
<a id="__codelineno-22-68" name="__codelineno-22-68" href="#__codelineno-22-68"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">txbuf</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-22-69" name="__codelineno-22-69" href="#__codelineno-22-69"></a><span class="w">        </span><span class="n">SPI_NAND_RD_PAGE_DATA</span><span class="p">,</span>
<a id="__codelineno-22-70" name="__codelineno-22-70" href="#__codelineno-22-70"></a><span class="w">        </span><span class="mh">0x00</span><span class="p">,</span><span class="w">   </span><span class="cm">/* dummy clock */</span>
<a id="__codelineno-22-71" name="__codelineno-22-71" href="#__codelineno-22-71"></a><span class="w">        </span><span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">page</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"> </span>
<a id="__codelineno-22-72" name="__codelineno-22-72" href="#__codelineno-22-72"></a><span class="w">        </span><span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">page</span><span class="p">),</span>
<a id="__codelineno-22-73" name="__codelineno-22-73" href="#__codelineno-22-73"></a><span class="w">    </span><span class="p">};</span><span class="w">  </span>
<a id="__codelineno-22-74" name="__codelineno-22-74" href="#__codelineno-22-74"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">spi0_write_then_read</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">txbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">txbuf</span><span class="p">),</span>
<a id="__codelineno-22-75" name="__codelineno-22-75" href="#__codelineno-22-75"></a><span class="w">                                </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">);</span>
<a id="__codelineno-22-76" name="__codelineno-22-76" href="#__codelineno-22-76"></a><span class="p">}</span>
<a id="__codelineno-22-77" name="__codelineno-22-77" href="#__codelineno-22-77"></a>
<a id="__codelineno-22-78" name="__codelineno-22-78" href="#__codelineno-22-78"></a><span class="k">static</span><span class="w"> </span><span class="kt">ssize_t</span>
<a id="__codelineno-22-79" name="__codelineno-22-79" href="#__codelineno-22-79"></a><span class="nf">spi_nand_read_from_cache_op</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sunxi_spi</span><span class="w"> </span><span class="o">*</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">column</span><span class="p">,</span>
<a id="__codelineno-22-80" name="__codelineno-22-80" href="#__codelineno-22-80"></a><span class="w">                            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">rxbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<a id="__codelineno-22-81" name="__codelineno-22-81" href="#__codelineno-22-81"></a><span class="p">{</span>
<a id="__codelineno-22-82" name="__codelineno-22-82" href="#__codelineno-22-82"></a><span class="w">    </span><span class="n">u8</span><span class="w"> </span><span class="n">txbuf</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-22-83" name="__codelineno-22-83" href="#__codelineno-22-83"></a><span class="w">        </span><span class="n">SPI_NAND_RD_DATA</span><span class="p">,</span>
<a id="__codelineno-22-84" name="__codelineno-22-84" href="#__codelineno-22-84"></a><span class="w">        </span><span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">column</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"> </span>
<a id="__codelineno-22-85" name="__codelineno-22-85" href="#__codelineno-22-85"></a><span class="w">        </span><span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">column</span><span class="p">),</span>
<a id="__codelineno-22-86" name="__codelineno-22-86" href="#__codelineno-22-86"></a><span class="w">        </span><span class="mh">0x00</span><span class="p">,</span><span class="w">   </span><span class="cm">/* dummy clock */</span>
<a id="__codelineno-22-87" name="__codelineno-22-87" href="#__codelineno-22-87"></a><span class="w">    </span><span class="p">};</span><span class="w">  </span>
<a id="__codelineno-22-88" name="__codelineno-22-88" href="#__codelineno-22-88"></a>
<a id="__codelineno-22-89" name="__codelineno-22-89" href="#__codelineno-22-89"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">spi0_write_then_read</span><span class="p">(</span><span class="n">spi</span><span class="p">,</span><span class="w"> </span><span class="n">txbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">txbuf</span><span class="p">),</span><span class="w"> </span><span class="n">rxbuf</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-22-90" name="__codelineno-22-90" href="#__codelineno-22-90"></a><span class="p">}</span><span class="w">     </span>
</code></pre></div></p>
<blockquote>
<h4 id="f1c100s-spi">全志 F1C100s SPI裸机通信的</h4>
</blockquote>
<p>第一步就是开时钟这些。比较关键的就是发送接收，下面是些寄存器相关的操作</p>
<p>SPI_MBC_REG (SPI Burst Counter Register)寄存器，里面存的是 （发 + 收）字节的总和
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="w">    </span><span class="cm">/* Burst counter (total bytes) */</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">n_tx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_rx</span><span class="p">,</span><span class="w"> </span><span class="n">spi_bc_reg</span><span class="p">);</span>
</code></pre></div>
SPI_TCR_REG (SPI Transfer Control Register)，这里面需要存入发送的字节数
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="w">    </span><span class="cm">/* Transfer counter (bytes to send) */</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="n">writel</span><span class="p">(</span><span class="n">n_tx</span><span class="p">,</span><span class="w"> </span><span class="n">spi_tc_reg</span><span class="p">);</span>
</code></pre></div></p>
<p>SPI_BCC_REG (SPI Burst Control Register)， sun6i变体还要将发送字节数写入该寄存器
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">is_sun6i</span><span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">        </span><span class="n">writel</span><span class="p">(</span><span class="n">n_tx</span><span class="p">,</span><span class="w"> </span><span class="n">spi_bcc_reg</span><span class="p">);</span>
</code></pre></div></p>
<p>SPI_TXD_REG (SPI TX Data Register)， 将要发送的字节依次写入该寄存器。数量不应超过fifo长度。
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_tx</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">        </span><span class="n">writeb</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">txbuf8</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">spi_tx_reg</span><span class="p">);</span>
</code></pre></div></p>
<p>SPI_TCR_REG (SPI Transfer Control Register)，通过置位该寄存器的第31位，触发传输流程
<img alt="image" src="https://img2023.cnblogs.com/blog/2605173/202308/2605173-20230810151058237-67062592.png" /></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="w">    </span><span class="cm">/* Start the data transfer */</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">    </span><span class="n">setbits_le32</span><span class="p">(</span><span class="n">spi_ctl_reg</span><span class="p">,</span><span class="w"> </span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">spi_ctl_xch_bitmask</span><span class="p">);</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">    </span><span class="n">udelay</span><span class="p">(</span><span class="n">real_delay</span><span class="p">);</span>
</code></pre></div>
<p>SPI_FSR_REG (SPI FIFO Status Register)，该寄存器低8位表示RX FIFO中接收的字节数，最大64 bytes
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="w">    </span><span class="cm">/* Wait until everything is received in the RX FIFO */</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">spi_fifo_reg</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">n_rx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></p>
<p>因为控制器内部原因，需要跳过一部分RX寄存器中的无效值。
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="w">    </span><span class="cm">/* Skip bytes */</span><span class="w">                                                                                                                                                         </span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">skip_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_tx</span><span class="p">;</span><span class="w"> </span><span class="n">skip_bytes</span><span class="o">--</span><span class="p">;)</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">        </span><span class="n">readb</span><span class="p">(</span><span class="n">spi_rx_reg</span><span class="p">);</span>
</code></pre></div></p>
<h2 id="_9">参考资料</h2>
<p><a href="https://www.cnblogs.com/yanye0xff/p/16341719.html">F1C100S-BOOTROM与SPL阶段</a>
<a href="https://whycan.com/t_3123.html">V3s SPI NAND u-boot @openwrt</a>
<a href="https://whycan.com/t_2449.html#p19694">V3s/S3/f1c100s通过USB启动Linux,并把SD NAND/TF卡挂载为U盘, 可以dd或Win32DiskImager任烧写</a></p>
<h2 align="center">
    <img src="https://img2023.cnblogs.com/blog/2605173/202306/2605173-20230630172026689-623565333.png" width="10%" alt="embeddedboys logo" />
</h2>
<h2 align="center">
    <a href="https://embeddedboys.github.io/">embeddedboys</a> 献上
</h2>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2023 embeddedboys
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://embeddedboys.github.io/NINJAR-lite/" target="_blank" rel="noopener" title="NINJAR-lite on Github" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["search.suggest", "search.highlight", "search.share"], "search": "../../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.6c14ae12.min.js"></script>
      
    
  </body>
</html>